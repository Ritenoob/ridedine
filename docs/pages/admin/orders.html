<!-- Admin Orders Management -->
<div class="admin-layout">
  <aside class="admin-sidebar">
    <div class="admin-brand">
      <h2>üîê Admin Portal</h2>
    </div>
    <nav class="admin-nav">
      <a href="#" onclick="navigateTo('/admin'); return false;">üìä Dashboard</a>
      <a href="#" onclick="navigateTo('/admin/orders'); return false;" class="active">üì¶ Orders</a>
      <a href="#" onclick="navigateTo('/admin/customers'); return false;">üë• Customers</a>
      <a href="#" onclick="navigateTo('/admin/drivers'); return false;">üöó Drivers</a>
      <a href="#" onclick="navigateTo('/admin/operations'); return false;">üìä Operations</a>
      <a href="#" onclick="navigateTo('/admin/payouts'); return false;">üí∞ Payouts</a>
      <a href="#" onclick="navigateTo('/admin/disputes'); return false;">‚ö†Ô∏è Disputes</a>
      <a href="#" onclick="navigateTo('/admin/integrations'); return false;">üîå Integrations</a>
      <a href="#" onclick="navigateTo('/admin/live-map'); return false;">üó∫Ô∏è Live Map</a>
      <a href="#" onclick="navigateTo('/admin/driver-simulator'); return false;">üéÆ Simulator</a>
      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 12px 0;">
      <a href="#" onclick="navigateTo('/admin/legal/terms'); return false;">üìÑ Terms</a>
      <a href="#" onclick="navigateTo('/admin/legal/privacy'); return false;">üîí Privacy</a>
    </nav>
  </aside>

  <main class="admin-main">
    <header class="admin-header">
      <h1>Order Management</h1>
      <div style="display: flex; gap: 12px; align-items: center;">
        <button id="refreshBtn" class="button button--outline" onclick="loadOrders()">
          üîÑ Refresh
        </button>
        <button id="logoutBtn" class="button">Logout</button>
      </div>
    </header>

    <div class="admin-content">
      <!-- Filters -->
      <div class="card" style="margin-bottom: 24px;">
        <div class="card__body">
          <div style="display: flex; gap: 16px; align-items: center;">
            <label style="font-weight: 600;">Filter by Status:</label>
            <select id="statusFilter" onchange="loadOrders()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
              <option value="">All Orders</option>
              <option value="CREATED">Created</option>
              <option value="CONFIRMED">Confirmed</option>
              <option value="PREPARING">Preparing</option>
              <option value="READY">Ready</option>
              <option value="PICKED_UP">Picked Up</option>
              <option value="EN_ROUTE">En Route</option>
              <option value="DELIVERED">Delivered</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Orders Table -->
      <div class="card">
        <div class="card__body p-0">
          <div id="loadingSpinner" style="text-align: center; padding: 40px;">
            <p style="color: #718096;">Loading orders...</p>
          </div>

          <div id="ordersTable" style="display: none;">
            <table class="table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Email</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
                <!-- Rows will be inserted here -->
              </tbody>
            </table>
          </div>

          <div id="noOrders" style="display: none; text-align: center; padding: 60px 20px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">üì¶</div>
            <h3 style="margin: 0 0 8px 0; color: #1a202c;">No Orders Found</h3>
            <p style="color: #718096; margin: 0;">No orders match the selected filters</p>
          </div>

          <div id="errorMessage" style="display: none; padding: 20px; background: #fed7d7; color: #742a2a; border-radius: 8px; margin: 20px;">
            <!-- Error message will appear here -->
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Status Update Modal -->
<div id="statusModal" class="modal" style="display: none;">
  <div class="modal__overlay" onclick="closeStatusModal()"></div>
  <div class="modal__content">
    <div class="modal__header">
      <h2>Update Order Status</h2>
      <button class="modal__close" onclick="closeStatusModal()">√ó</button>
    </div>
    <div class="modal__body">
      <p><strong>Order ID:</strong> <span id="modalOrderId"></span></p>
      <p><strong>Current Status:</strong> <span id="modalCurrentStatus"></span></p>
      <div style="margin-top: 24px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">New Status:</label>
        <select id="newStatus" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 16px;">
          <option value="CREATED">Created</option>
          <option value="CONFIRMED">Confirmed</option>
          <option value="PREPARING">Preparing</option>
          <option value="READY">Ready</option>
          <option value="PICKED_UP">Picked Up</option>
          <option value="EN_ROUTE">En Route</option>
          <option value="DELIVERED">Delivered</option>
        </select>
      </div>
    </div>
    <div class="modal__footer">
      <button class="button button--ghost" onclick="closeStatusModal()">Cancel</button>
      <button class="button button--primary" onclick="updateStatus()">Update Status</button>
    </div>
  </div>
</div>

<style>
  .admin-layout { display: flex; min-height: 100vh; }
  .admin-sidebar { width: 250px; background: #1a202c; color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
  .admin-brand h2 { margin: 0 0 24px 0; font-size: 1.2rem; }
  .admin-nav { display: flex; flex-direction: column; gap: 4px; }
  .admin-nav a { padding: 10px 12px; border-radius: 6px; color: #cbd5e0; text-decoration: none; transition: all 0.2s; }
  .admin-nav a:hover, .admin-nav a.active { background: #2d3748; color: white; }
  .admin-main { margin-left: 250px; flex: 1; background: #f7fafc; }
  .admin-header { background: white; padding: 20px 32px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .admin-header h1 { margin: 0; }
  .admin-content { padding: 32px; }
  
  .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .card__body { padding: 24px; }
  .card__body.p-0 { padding: 0; }
  
  .table { width: 100%; border-collapse: collapse; }
  .table thead { background: #f7fafc; }
  .table th { padding: 16px; text-align: left; font-weight: 600; color: #4a5568; border-bottom: 2px solid #e2e8f0; }
  .table td { padding: 16px; border-bottom: 1px solid #e2e8f0; color: #1a202c; }
  .table tbody tr:hover { background: #f7fafc; }
  .table tbody tr:last-child td { border-bottom: none; }
  
  .badge { padding: 6px 12px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; display: inline-block; }
  .badge--created { background: #e6fffa; color: #047481; }
  .badge--confirmed { background: #bee3f8; color: #2c5282; }
  .badge--preparing { background: #fef5e7; color: #975a16; }
  .badge--ready { background: #c6f6d5; color: #22543d; }
  .badge--pickedup { background: #feebc8; color: #7c2d12; }
  .badge--enroute { background: #fed7e2; color: #97266d; }
  .badge--delivered { background: #c6f6d5; color: #22543d; }
  
  .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; }
  .modal__overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
  .modal__content { position: relative; max-width: 500px; margin: 100px auto; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
  .modal__header { padding: 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .modal__header h2 { margin: 0; font-size: 1.5rem; }
  .modal__close { background: none; border: none; font-size: 2rem; cursor: pointer; color: #718096; line-height: 1; }
  .modal__close:hover { color: #1a202c; }
  .modal__body { padding: 24px; }
  .modal__footer { padding: 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px; }
  
  .button { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
  .button--primary { background: #ff7a18; color: white; }
  .button--primary:hover { background: #e66910; }
  .button--outline { background: white; border: 1px solid #e2e8f0; color: #4a5568; }
  .button--outline:hover { background: #f7fafc; }
  .button--ghost { background: none; color: #718096; }
  .button--ghost:hover { background: #f7fafc; }
  .button--sm { padding: 6px 12px; font-size: 0.875rem; }
</style>

<script>
  let currentOrderId = null;
  let currentOrderStatus = null;

  async function loadOrders() {
    const statusFilter = document.getElementById('statusFilter').value;
    const spinner = document.getElementById('loadingSpinner');
    const table = document.getElementById('ordersTable');
    const noOrders = document.getElementById('noOrders');
    const errorMessage = document.getElementById('errorMessage');
    
    // Show loading
    spinner.style.display = 'block';
    table.style.display = 'none';
    noOrders.style.display = 'none';
    errorMessage.style.display = 'none';

    try {
      const url = statusFilter 
        ? `/api/admin/orders?status=${encodeURIComponent(statusFilter)}`
        : '/api/admin/orders';
      
      const response = await window.apiFetch(url, {
        method: 'GET'
      });

      if (!response.ok) {
        throw new Error('Failed to load orders');
      }

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Failed to load orders');
      }

      const orders = result.data || [];
      
      if (orders.length === 0) {
        spinner.style.display = 'none';
        noOrders.style.display = 'block';
        return;
      }

      // Render orders
      renderOrders(orders);
      
      spinner.style.display = 'none';
      table.style.display = 'block';
    } catch (error) {
      console.error('Error loading orders:', error);
      errorMessage.textContent = error.message || 'Failed to load orders';
      errorMessage.style.display = 'block';
      spinner.style.display = 'none';
    }
  }

  function renderOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');
    
    tbody.innerHTML = orders.map(order => {
      const statusClass = getStatusClass(order.status);
      const createdDate = formatDate(order.created_at);
      
      return `
        <tr>
          <td><strong>#${order.id}</strong></td>
          <td>${escapeHtml(order.customer_name || 'N/A')}</td>
          <td>${escapeHtml(order.customer_email || 'N/A')}</td>
          <td><strong>$${parseFloat(order.total || 0).toFixed(2)}</strong></td>
          <td><span class="badge ${statusClass}">${escapeHtml(order.status)}</span></td>
          <td>${createdDate}</td>
          <td>
            <button 
              class="button button--sm button--outline"
              data-order-id="${order.id}"
              data-order-status="${escapeHtml(order.status)}"
              onclick="openStatusModal(this.getAttribute('data-order-id'), this.getAttribute('data-order-status'))"
            >
              Update
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function getStatusClass(status) {
    const statusMap = {
      'CREATED': 'badge--created',
      'CONFIRMED': 'badge--confirmed',
      'PREPARING': 'badge--preparing',
      'READY': 'badge--ready',
      'PICKED_UP': 'badge--pickedup',
      'EN_ROUTE': 'badge--enroute',
      'DELIVERED': 'badge--delivered'
    };
    return statusMap[status] || 'badge--created';
  }

  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    } catch (e) {
      return dateString;
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function openStatusModal(orderId, currentStatus) {
    currentOrderId = orderId;
    currentOrderStatus = currentStatus;
    
    document.getElementById('modalOrderId').textContent = '#' + orderId;
    document.getElementById('modalCurrentStatus').textContent = currentStatus;
    document.getElementById('newStatus').value = currentStatus;
    document.getElementById('statusModal').style.display = 'block';
  }

  function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
    currentOrderId = null;
    currentOrderStatus = null;
  }

  async function updateStatus() {
    const newStatus = document.getElementById('newStatus').value;
    
    if (!currentOrderId || !newStatus) {
      alert('Please select a status');
      return;
    }

    try {
      const response = await window.apiFetch(`/api/admin/orders/${currentOrderId}/status`, {
        method: 'PATCH',
        body: {
          status: newStatus
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to update status');
      }

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error || 'Failed to update status');
      }

      // Success
      closeStatusModal();
      loadOrders(); // Reload orders
      
      if (window.showToast) {
        window.showToast('Order status updated successfully', 'success');
      } else {
        alert('Order status updated successfully');
      }
    } catch (error) {
      console.error('Error updating status:', error);
      alert(error.message || 'Failed to update status');
    }
  }

  // Load orders on page load
  loadOrders();
  
  // Refresh every 30 seconds
  setInterval(loadOrders, 30000);
</script>
