<!-- Integrations Management -->
<div class="admin-layout">
  <aside class="admin-sidebar">
    <div class="admin-brand">
      <img src="/assets/logo.svg" alt="RideNDine" style="width: 100%; height: auto; padding: 1rem;" />
    </div>
    <nav class="admin-nav">
      <a href="#" onclick="navigateTo('/admin'); return false;">üìä Dashboard</a>
      <a href="#" onclick="navigateTo('/admin/customers'); return false;">üë• Customers</a>
      <a href="#" onclick="navigateTo('/admin/drivers'); return false;">üöó Drivers</a>
      <a href="#" onclick="navigateTo('/admin/operations'); return false;">üì¶ Operations</a>
      <a href="#" onclick="navigateTo('/admin/payouts'); return false;">üí∞ Payouts</a>
      <a href="#" onclick="navigateTo('/admin/disputes'); return false;">‚ö†Ô∏è Disputes</a>
      <a href="#" onclick="navigateTo('/admin/integrations'); return false;" class="active">üîå Integrations</a>
      <a href="#" onclick="navigateTo('/admin/live-map'); return false;">üó∫Ô∏è Live Map</a>
      <a href="#" onclick="navigateTo('/admin/driver-simulator'); return false;">üéÆ Simulator</a>
      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 12px 0;">
      <a href="#" onclick="navigateTo('/admin/legal/terms'); return false;">üìÑ Terms</a>
      <a href="#" onclick="navigateTo('/admin/legal/privacy'); return false;">üîí Privacy</a>
    </nav>
  </aside>

  <main class="admin-main">
    <header class="admin-header">
      <h1>Integrations</h1>
      <button id="logoutBtn" class="button">Logout</button>
    </header>

    <div class="admin-content">
      <!-- Integrations Grid -->
      <div class="integrations-grid">
        <!-- Cooco Integration -->
        <div class="integration-card">
          <div class="integration-icon">üç±</div>
          <h3>Cooco Meal Plan</h3>
          <p class="integration-description">
            Connect to Cooco meal planning app to import menus and sync store data.
          </p>
          <div class="integration-status">
            <span class="status-badge status-warning">Manual Import</span>
          </div>
          <div class="integration-actions">
            <button class="button button--primary" onclick="openCooco()">
              üîó Open Cooco
            </button>
            <button class="button button--outline" onclick="showCoocoImport()">
              üì• Import Menu
            </button>
          </div>
          <div class="integration-config">
            <label>
              Store/Account Name:
              <input type="text" id="coocoStoreName" placeholder="e.g., My Kitchen" class="input-field" />
            </label>
            <label>
              Import Mode:
              <select id="coocoImportMode" class="input-field">
                <option value="manual">Manual Paste</option>
                <option value="api" disabled>API (Coming Soon)</option>
              </select>
            </label>
            <button class="button button--sm" onclick="saveCoocoConfig()">Save Config</button>
          </div>
        </div>

        <!-- Hoang Gia Pho Integration -->
        <div class="integration-card">
          <div class="integration-icon">üçú</div>
          <h3>Hoang Gia Pho</h3>
          <p class="integration-description">
            Connect to Hoang Gia Pho restaurant storefront for menu sync and order management.
          </p>
          <div class="integration-status">
            <span class="status-badge status-success">Active</span>
          </div>
          <div class="integration-actions">
            <button class="button button--primary" onclick="openChefSite()">
              üîó Open Storefront
            </button>
            <button class="button button--outline" onclick="showChefImport()">
              üì• Sync Menu
            </button>
          </div>
          <div class="integration-config">
            <label>
              Store ID:
              <input type="text" value="store_hoang_gia_pho" class="input-field" readonly />
            </label>
            <label>
              Website:
              <input type="url" id="chefWebsite" value="https://hoang-gia-pho-site-of8l.vercel.app/hoang-gia-pho-delivery.html" class="input-field" readonly />
            </label>
            <label>
              Sync Mode:
              <select id="chefSyncMode" class="input-field">
                <option value="manual">Manual Paste</option>
                <option value="scrape" disabled>Auto-Scrape (Coming Soon)</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Stripe Integration -->
        <div class="integration-card">
          <div class="integration-icon">üí≥</div>
          <h3>Stripe Payments</h3>
          <p class="integration-description">
            Payment processing for customer orders. Currently in <strong id="stripeMode">demo mode</strong>.
          </p>
          <div class="integration-status">
            <span class="status-badge status-success" id="stripeStatus">Connected</span>
          </div>
          <div class="integration-actions">
            <button class="button button--outline" onclick="testStripe()">
              üß™ Test Payment
            </button>
          </div>
        </div>

        <!-- Mealbridge Integration -->
        <div class="integration-card">
          <div class="integration-icon">üöö</div>
          <h3>Mealbridge Dispatch</h3>
          <p class="integration-description">
            Order routing and driver dispatch system. Integrated with simulator.
          </p>
          <div class="integration-status">
            <span class="status-badge status-success">Active</span>
          </div>
          <div class="integration-actions">
            <button class="button button--outline" onclick="navigateTo('/admin/driver-simulator')">
              üéÆ Open Simulator
            </button>
          </div>
        </div>
      </div>

      <!-- Menu Import Modal -->
      <div id="importModal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="importModalTitle">Import Menu Items</h2>
            <button onclick="closeImportModal()" class="button button--sm">‚úï</button>
          </div>
          <div class="modal-body">
            <p>Paste menu items in CSV format: <code>name,price,category</code></p>
            <textarea id="menuImportData" rows="10" placeholder="Pho Bo,12.99,Soup&#10;Spring Rolls,6.99,Appetizer&#10;Bun Cha,13.99,Main" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: monospace;"></textarea>
            <div style="margin-top: 16px; display: flex; gap: 12px;">
              <button class="button button--primary" onclick="processMenuImport()">Import Items</button>
              <button class="button button--outline" onclick="closeImportModal()">Cancel</button>
            </div>
            <div id="importResult" style="margin-top: 16px;"></div>
          </div>
        </div>
      </div>

      <!-- Integration Logs Section -->
      <div style="margin-top: 48px;">
        <h2>Recent Integration Events</h2>
        <div class="table-container" style="margin-top: 16px;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Integration</th>
                <th>Event</th>
                <th>Status</th>
                <th>Message</th>
              </tr>
            </thead>
            <tbody id="logsTable">
              <tr>
                <td colspan="5" style="text-align: center;">Loading logs...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<style>
  .admin-layout { display: flex; min-height: 100vh; }
  .admin-sidebar { width: 250px; background: #1a202c; color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
  .admin-brand { margin-bottom: 24px; }
  .admin-nav { display: flex; flex-direction: column; gap: 4px; }
  .admin-nav a { padding: 10px 12px; border-radius: 6px; color: #cbd5e0; transition: all 0.2s; }
  .admin-nav a:hover, .admin-nav a.active { background: #2d3748; color: white; }
  .admin-main { margin-left: 250px; flex: 1; background: var(--sand); }
  .admin-header { background: white; padding: 20px 32px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .admin-header h1 { margin: 0; }
  .admin-content { padding: 32px; }
  
  /* Integrations Grid */
  .integrations-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-bottom: 48px; }
  .integration-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; }
  .integration-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15); transform: translateY(-2px); }
  .integration-icon { font-size: 3rem; margin-bottom: 16px; }
  .integration-card h3 { margin: 0 0 12px 0; font-size: 1.5rem; color: #1a202c; }
  .integration-description { color: #718096; margin-bottom: 16px; line-height: 1.6; }
  .integration-status { margin-bottom: 16px; }
  .integration-actions { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .integration-config { background: #f7fafc; padding: 16px; border-radius: 8px; margin-top: 16px; }
  .integration-config label { display: block; margin-bottom: 12px; font-size: 0.875rem; font-weight: 500; color: #4a5568; }
  .input-field { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; margin-top: 4px; font-size: 14px; }
  .input-field:focus { outline: none; border-color: var(--teal); }
  
  /* Status badges */
  .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
  .status-success { background: #c6f6d5; color: #22543d; }
  .status-error { background: #fed7d7; color: #742a2a; }
  .status-warning { background: #fef5e7; color: #b7791f; }
  
  /* Modal */
  .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; }
  .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
  .modal-header { padding: 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .modal-header h2 { margin: 0; }
  .modal-body { padding: 24px; }
  
  /* Tables */
  .table-container { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; }
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { background: #f7fafc; padding: 16px; text-align: left; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
  .data-table td { padding: 16px; border-bottom: 1px solid #e2e8f0; }
  .data-table tr:hover { background: #f7fafc; }
  
  @media (max-width: 768px) {
    .admin-sidebar { display: none; } /* Will add hamburger menu later */
    .admin-main { margin-left: 0; }
    .integrations-grid { grid-template-columns: 1fr; }
  }
</style>

<script>
(async function() {
  // Check admin authentication
  try {
    const res = await window.apiFetch('/api/auth/session');
    const data = await res.json();
    if (!data.authenticated || data.role !== 'admin') {
      navigateTo('/admin/login');
      return;
    }
  } catch (error) {
    navigateTo('/admin/login');
    return;
  }

  let currentIntegrationType = null;
  let menuImportData = [];

  // Open Cooco
  window.openCooco = function() {
    window.open('https://cooco.app/mealplan', '_blank');
    window.showToast('‚úÖ Opened Cooco in new tab', 'success');
  };

  // Open Chef Site
  window.openChefSite = function() {
    const url = document.getElementById('chefWebsite').value;
    window.open(url, '_blank');
    window.showToast('‚úÖ Opened chef storefront in new tab', 'success');
  };

  // Show import modal
  window.showCoocoImport = function() {
    currentIntegrationType = 'cooco';
    document.getElementById('importModalTitle').textContent = 'Import Cooco Menu Items';
    document.getElementById('importModal').style.display = 'flex';
  };

  window.showChefImport = function() {
    currentIntegrationType = 'chef';
    document.getElementById('importModalTitle').textContent = 'Import Hoang Gia Pho Menu';
    document.getElementById('importModal').style.display = 'flex';
  };

  window.closeImportModal = function() {
    document.getElementById('importModal').style.display = 'none';
    document.getElementById('menuImportData').value = '';
    document.getElementById('importResult').innerHTML = '';
  };

  // Process menu import
  window.processMenuImport = async function() {
    const data = document.getElementById('menuImportData').value.trim();
    if (!data) {
      document.getElementById('importResult').innerHTML = '<p style="color: red;">Please enter menu data</p>';
      return;
    }

    try {
      // Parse CSV data
      const lines = data.split('\n').filter(line => line.trim());
      const items = [];

      for (const line of lines) {
        const parts = line.split(',').map(p => p.trim());
        if (parts.length >= 2) {
          const [name, price, category = 'General'] = parts;
          items.push({
            name,
            price: parseFloat(price),
            category
          });
        }
      }

      if (items.length === 0) {
        document.getElementById('importResult').innerHTML = '<p style="color: red;">No valid items found. Format: name,price,category</p>';
        return;
      }

      // Save to integration settings
      const storeId = currentIntegrationType === 'cooco' 
        ? document.getElementById('coocoStoreName').value || 'cooco_store'
        : 'store_hoang_gia_pho';

      const response = await window.apiFetch('/api/integrations/import-menu', {
        method: 'POST',
        body: {
          integrationType: currentIntegrationType,
          storeId,
          items
        }
      });

      if (response.ok) {
        document.getElementById('importResult').innerHTML = `<p style="color: green;">‚úÖ Successfully imported ${items.length} menu items!</p>`;
        window.showToast(`‚úÖ Imported ${items.length} items`, 'success');
        
        // Auto-close after 2 seconds
        setTimeout(() => closeImportModal(), 2000);
      } else {
        const error = await response.json();
        document.getElementById('importResult').innerHTML = `<p style="color: red;">Error: ${error.error || 'Import failed'}</p>`;
      }
    } catch (error) {
      console.error('Import error:', error);
      document.getElementById('importResult').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
    }
  };

  // Save Cooco config
  window.saveCoocoConfig = async function() {
    const storeName = document.getElementById('coocoStoreName').value;
    const importMode = document.getElementById('coocoImportMode').value;

    if (!storeName) {
      window.showToast('‚ö†Ô∏è Please enter a store name', 'warning');
      return;
    }

    try {
      const response = await window.apiFetch('/api/integrations/cooco-config', {
        method: 'POST',
        body: { storeName, importMode }
      });

      if (response.ok) {
        window.showToast('‚úÖ Cooco configuration saved', 'success');
      } else {
        window.showToast('‚ö†Ô∏è Failed to save configuration', 'error');
      }
    } catch (error) {
      console.error('Save config error:', error);
      window.showToast('‚ö†Ô∏è Failed to save configuration', 'error');
    }
  };

  // Test Stripe
  window.testStripe = async function() {
    window.showToast('üß™ Testing payment...', 'info');
    
    try {
      const response = await window.apiFetch('/api/payments/create-intent', {
        method: 'POST',
        body: {
          items: [{ name: 'Test Item', price: 10.00, quantity: 1 }],
          amount: 10.00
        }
      });

      const data = await response.json();
      
      if (data.demoMode) {
        window.showToast('‚úÖ Demo payment successful!', 'success');
      } else if (data.clientSecret) {
        window.showToast('‚úÖ Stripe payment intent created', 'success');
      }
    } catch (error) {
      window.showToast('‚ö†Ô∏è Payment test failed', 'error');
    }
  };

  // Load integration logs
  async function loadLogs() {
    try {
      const res = await window.apiFetch('/api/integrations/logs');
      const data = await res.json();
      const logs = Array.isArray(data) ? data : (data.logs || []);
      
      renderLogs(logs);
    } catch (error) {
      console.error('Failed to fetch logs:', error);
      document.getElementById('logsTable').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #718096;">No recent events</td></tr>';
    }
  }

  function renderLogs(data) {
    const tbody = document.getElementById('logsTable');
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #718096;">No recent events</td></tr>';
      return;
    }

    tbody.innerHTML = data.slice(0, 10).map(log => {
      let statusClass = 'status-success';
      if (log.status === 'error') statusClass = 'status-error';
      if (log.status === 'warning') statusClass = 'status-warning';
      
      return `
        <tr>
          <td>${new Date(log.timestamp).toLocaleString()}</td>
          <td><strong>${(log.integration || 'N/A').toUpperCase()}</strong></td>
          <td>${log.eventType || log.type || 'N/A'}</td>
          <td><span class="status-badge ${statusClass}">${(log.status || 'unknown').toUpperCase()}</span></td>
          <td>${log.message || 'No message'}</td>
        </tr>
      `;
    }).join('');
  }

  // Check Stripe status
  async function checkStripeStatus() {
    try {
      const res = await window.apiFetch('/api/config');
      const data = await res.json();
      
      if (data.demoMode) {
        document.getElementById('stripeMode').textContent = 'demo mode';
        document.getElementById('stripeStatus').textContent = 'Demo Mode';
        document.getElementById('stripeStatus').className = 'status-badge status-warning';
      } else if (data.stripePublishableKey) {
        document.getElementById('stripeMode').textContent = 'live mode';
        document.getElementById('stripeStatus').textContent = 'Connected';
        document.getElementById('stripeStatus').className = 'status-badge status-success';
      } else {
        document.getElementById('stripeMode').textContent = 'not configured';
        document.getElementById('stripeStatus').textContent = 'Not Configured';
        document.getElementById('stripeStatus').className = 'status-badge status-error';
      }
    } catch (error) {
      console.error('Failed to check Stripe status:', error);
    }
  }

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await window.apiFetch('/api/auth/logout', { method: 'POST' });
    navigateTo('/');
  });

  // Initialize
  loadLogs();
  checkStripeStatus();
})();
</script>
