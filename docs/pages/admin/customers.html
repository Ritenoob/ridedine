<!-- Customer Management -->
<div class="admin-layout">
  <aside class="admin-sidebar">
    <div class="admin-brand">
      <h2>üîê Admin Portal</h2>
    </div>
    <nav class="admin-nav">
      <a href="#" onclick="navigateTo('/admin'); return false;">üìä Dashboard</a>
      <a href="#" onclick="navigateTo('/admin/customers'); return false;" class="active">üë• Customers</a>
      <a href="#" onclick="navigateTo('/admin/drivers'); return false;">üöó Drivers</a>
      <a href="#" onclick="navigateTo('/admin/operations'); return false;">üì¶ Operations</a>
      <a href="#" onclick="navigateTo('/admin/payouts'); return false;">üí∞ Payouts</a>
      <a href="#" onclick="navigateTo('/admin/disputes'); return false;">‚ö†Ô∏è Disputes</a>
      <a href="#" onclick="navigateTo('/admin/integrations'); return false;">üîå Integrations</a>
      <a href="#" onclick="navigateTo('/admin/live-map'); return false;">üó∫Ô∏è Live Map</a>
      <a href="#" onclick="navigateTo('/admin/driver-simulator'); return false;">üéÆ Simulator</a>
      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 12px 0;">
      <a href="#" onclick="navigateTo('/admin/legal/terms'); return false;">üìÑ Terms</a>
      <a href="#" onclick="navigateTo('/admin/legal/privacy'); return false;">üîí Privacy</a>
    </nav>
  </aside>

  <main class="admin-main">
    <header class="admin-header">
      <h1>Customer Management</h1>
      <button id="logoutBtn" class="button">Logout</button>
    </header>

    <div class="admin-content">
      <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="Search customers by name, email..." class="search-input">
        <select id="statusFilter" class="filter-select">
          <option value="">All Customers</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Customer Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Total Orders</th>
              <th>Total Spent</th>
              <th>Last Order</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="customersTable">
            <tr>
              <td colspan="7" style="text-align: center;">Loading customers...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="customerDetails" class="detail-panel" style="display: none;">
        <div class="detail-header">
          <h3>Customer Order History</h3>
          <button onclick="closeDetails()" class="button">Close</button>
        </div>
        <div id="orderHistory"></div>
      </div>
    </div>
  </main>
</div>

<style>
  .admin-layout { display: flex; min-height: 100vh; }
  .admin-sidebar { width: 250px; background: #1a202c; color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
  .admin-brand h2 { margin: 0 0 24px 0; font-size: 1.2rem; }
  .admin-nav { display: flex; flex-direction: column; gap: 4px; }
  .admin-nav a { padding: 10px 12px; border-radius: 6px; color: #cbd5e0; transition: all 0.2s; }
  .admin-nav a:hover, .admin-nav a.active { background: #2d3748; color: white; }
  .admin-main { margin-left: 250px; flex: 1; background: var(--sand); }
  .admin-header { background: white; padding: 20px 32px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .admin-header h1 { margin: 0; }
  .admin-content { padding: 32px; }
  .filter-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
  .search-input { flex: 1; min-width: 250px; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
  .filter-select { padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
  .table-container { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; }
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { background: #f7fafc; padding: 16px; text-align: left; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
  .data-table td { padding: 16px; border-bottom: 1px solid #e2e8f0; }
  .data-table tr:hover { background: #f7fafc; }
  .detail-panel { margin-top: 24px; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .action-btn-sm { padding: 6px 12px; background: var(--teal); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; }
  .action-btn-sm:hover { background: var(--teal-dark); }
</style>

<script>
(async function() {
  // Check admin authentication
  try {
    const res = await fetch('/api/auth/session');
    const data = await res.json();
    if (!data.authenticated || data.role !== 'admin') {
      navigateTo('/admin/login');
      return;
    }
  } catch (error) {
    navigateTo('/admin/login');
    return;
  }

  let customers = [];

  // Fetch customer data from orders
  async function loadCustomers() {
    try {
      const res = await fetch('/api/orders');
      const orders = await res.json();
      
      // Extract unique customers from orders
      const customerMap = new Map();
      orders.forEach(order => {
        const customerId = order.customer?.email || order.customerId || 'unknown';
        if (!customerMap.has(customerId)) {
          customerMap.set(customerId, {
            name: order.customer?.name || order.customerName || 'N/A',
            email: order.customer?.email || order.customerId || 'N/A',
            phone: order.customer?.phone || order.deliveryAddress?.phone || 'N/A',
            orders: [],
            totalSpent: 0
          });
        }
        const customer = customerMap.get(customerId);
        customer.orders.push(order);
        customer.totalSpent += order.total || 0;
      });

      customers = Array.from(customerMap.values());
      renderCustomers(customers);
    } catch (error) {
      console.error('Failed to fetch customers:', error);
      document.getElementById('customersTable').innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Failed to load customers</td></tr>';
    }
  }

  function renderCustomers(data) {
    const tbody = document.getElementById('customersTable');
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No customers found</td></tr>';
      return;
    }

    tbody.innerHTML = data.map(customer => `
      <tr>
        <td>${customer.name}</td>
        <td>${customer.email}</td>
        <td>${customer.phone}</td>
        <td>${customer.orders.length}</td>
        <td>$${customer.totalSpent.toFixed(2)}</td>
        <td>${customer.orders.length > 0 ? new Date(customer.orders[customer.orders.length - 1].createdAt).toLocaleDateString() : 'N/A'}</td>
        <td><button class="action-btn-sm" onclick="viewCustomer('${customer.email}')">View Orders</button></td>
      </tr>
    `).join('');
  }

  window.viewCustomer = function(email) {
    const customer = customers.find(c => c.email === email);
    if (!customer) return;

    const detailPanel = document.getElementById('customerDetails');
    const orderHistory = document.getElementById('orderHistory');

    orderHistory.innerHTML = `
      <h4>${customer.name} - Order History</h4>
      <table class="data-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          ${customer.orders.map(order => `
            <tr>
              <td>${order.orderId || order.id}</td>
              <td>${new Date(order.createdAt).toLocaleString()}</td>
              <td>${order.items?.length || 0} items</td>
              <td>$${(order.total || 0).toFixed(2)}</td>
              <td>${order.status || 'N/A'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    detailPanel.style.display = 'block';
    detailPanel.scrollIntoView({ behavior: 'smooth' });
  };

  window.closeDetails = function() {
    document.getElementById('customerDetails').style.display = 'none';
  };

  // Search functionality
  document.getElementById('searchInput').addEventListener('input', (e) => {
    const search = e.target.value.toLowerCase();
    const filtered = customers.filter(c => 
      c.name.toLowerCase().includes(search) || 
      c.email.toLowerCase().includes(search)
    );
    renderCustomers(filtered);
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await fetch('/api/auth/logout', { method: 'POST' });
    navigateTo('/');
  });

  loadCustomers();
})();
</script>
