<!-- Disputes Management -->
<div class="admin-layout">
  <aside class="admin-sidebar">
    <div class="admin-brand">
      <h2>ðŸ” Admin Portal</h2>
    </div>
    <nav class="admin-nav">
      <a href="#" onclick="navigateTo('/admin'); return false;">ðŸ“Š Dashboard</a>
      <a href="#" onclick="navigateTo('/admin/customers'); return false;">ðŸ‘¥ Customers</a>
      <a href="#" onclick="navigateTo('/admin/drivers'); return false;">ðŸš— Drivers</a>
      <a href="#" onclick="navigateTo('/admin/operations'); return false;">ðŸ“¦ Operations</a>
      <a href="#" onclick="navigateTo('/admin/payouts'); return false;">ðŸ’° Payouts</a>
      <a href="#" onclick="navigateTo('/admin/disputes'); return false;" class="active">âš ï¸ Disputes</a>
      <a href="#" onclick="navigateTo('/admin/integrations'); return false;">ðŸ”Œ Integrations</a>
      <a href="#" onclick="navigateTo('/admin/live-map'); return false;">ðŸ—ºï¸ Live Map</a>
      <a href="#" onclick="navigateTo('/admin/driver-simulator'); return false;">ðŸŽ® Simulator</a>
      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 12px 0;">
      <a href="#" onclick="navigateTo('/admin/legal/terms'); return false;">ðŸ“„ Terms</a>
      <a href="#" onclick="navigateTo('/admin/legal/privacy'); return false;">ðŸ”’ Privacy</a>
    </nav>
  </aside>

  <main class="admin-main">
    <header class="admin-header">
      <h1>Disputes & Refunds</h1>
      <button id="logoutBtn" class="button">Logout</button>
    </header>

    <div class="admin-content">
      <div class="metric-grid" style="margin-bottom: 24px;">
        <div class="metric-card">
          <div class="metric-label">Open Disputes</div>
          <div class="metric-value" style="color: var(--orange);">5</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Resolved This Week</div>
          <div class="metric-value" style="color: #48bb78;">12</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Total Refunded</div>
          <div class="metric-value" style="font-size: 1.5rem;">$845.50</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Dispute Rate</div>
          <div class="metric-value" style="font-size: 1.5rem;">2.1%</div>
        </div>
      </div>

      <div class="filter-bar">
        <select id="statusFilter" class="filter-select">
          <option value="">All Status</option>
          <option value="open">Open</option>
          <option value="investigating">Investigating</option>
          <option value="resolved">Resolved</option>
          <option value="rejected">Rejected</option>
        </select>
        <select id="typeFilter" class="filter-select">
          <option value="">All Types</option>
          <option value="wrong-order">Wrong Order</option>
          <option value="missing-items">Missing Items</option>
          <option value="quality">Quality Issue</option>
          <option value="late-delivery">Late Delivery</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Dispute ID</th>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="disputesTable"></tbody>
        </table>
      </div>

      <div id="disputeDetail" class="detail-panel" style="display: none;">
        <div class="detail-header">
          <h3>Dispute Details</h3>
          <button onclick="closeDetail()" class="button">Close</button>
        </div>
        <div id="disputeContent"></div>
      </div>
    </div>
  </main>
</div>

<style>
  .admin-layout { display: flex; min-height: 100vh; }
  .admin-sidebar { width: 250px; background: #1a202c; color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
  .admin-brand h2 { margin: 0 0 24px 0; font-size: 1.2rem; }
  .admin-nav { display: flex; flex-direction: column; gap: 4px; }
  .admin-nav a { padding: 10px 12px; border-radius: 6px; color: #cbd5e0; transition: all 0.2s; }
  .admin-nav a:hover, .admin-nav a.active { background: #2d3748; color: white; }
  .admin-main { margin-left: 250px; flex: 1; background: var(--sand); }
  .admin-header { background: white; padding: 20px 32px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .admin-header h1 { margin: 0; }
  .admin-content { padding: 32px; }
  .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .metric-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .metric-label { font-size: 0.875rem; color: #718096; margin-bottom: 8px; }
  .metric-value { font-size: 2rem; font-weight: bold; color: var(--teal); }
  .filter-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
  .filter-select { padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
  .table-container { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; }
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { background: #f7fafc; padding: 16px; text-align: left; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
  .data-table td { padding: 16px; border-bottom: 1px solid #e2e8f0; }
  .data-table tr:hover { background: #f7fafc; }
  .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
  .status-open { background: #fed7d7; color: #742a2a; }
  .status-investigating { background: #fef5e7; color: #b7791f; }
  .status-resolved { background: #c6f6d5; color: #22543d; }
  .status-rejected { background: #e2e8f0; color: #4a5568; }
  .action-btn-sm { padding: 6px 12px; background: var(--teal); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; margin-right: 4px; }
  .action-btn-sm:hover { background: var(--teal-dark); }
  .detail-panel { margin-top: 24px; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .dispute-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px; }
  .info-item { padding: 12px; background: var(--sand); border-radius: 8px; }
  .info-label { font-size: 0.875rem; color: #718096; margin-bottom: 4px; }
  .info-value { font-weight: 600; }
</style>

<script>
(async function() {
  // Check admin authentication
  try {
    const res = await window.apiFetch('/api/auth/session');
    const data = await res.json();
    if (!data.authenticated || data.role !== 'admin') {
      navigateTo('/admin/login');
      return;
    }
  } catch (error) {
    navigateTo('/admin/login');
    return;
  }

  // Mock dispute data
  const disputes = [
    { id: 'DS-001', orderId: 'ORD-1245', customer: 'John Doe', type: 'wrong-order', amount: 45.50, status: 'open', created: '2024-01-22', description: 'Received wrong items in order' },
    { id: 'DS-002', orderId: 'ORD-1238', customer: 'Jane Smith', type: 'missing-items', amount: 12.00, status: 'investigating', created: '2024-01-21', description: 'Missing side dish' },
    { id: 'DS-003', orderId: 'ORD-1230', customer: 'Bob Wilson', type: 'quality', amount: 38.75, status: 'open', created: '2024-01-20', description: 'Food quality not as expected' },
    { id: 'DS-004', orderId: 'ORD-1225', customer: 'Alice Brown', type: 'late-delivery', amount: 0, status: 'resolved', created: '2024-01-19', description: 'Delivery was 45 minutes late' },
    { id: 'DS-005', orderId: 'ORD-1220', customer: 'Charlie Davis', type: 'wrong-order', amount: 52.25, status: 'resolved', created: '2024-01-18', description: 'Wrong order delivered, refunded' },
    { id: 'DS-006', orderId: 'ORD-1215', customer: 'Eva Martinez', type: 'missing-items', amount: 8.50, status: 'rejected', created: '2024-01-17', description: 'Claimed missing item, found in bag' },
    { id: 'DS-007', orderId: 'ORD-1210', customer: 'Frank Lee', type: 'quality', amount: 42.00, status: 'investigating', created: '2024-01-16', description: 'Food temperature issue' },
    { id: 'DS-008', orderId: 'ORD-1205', customer: 'Grace Chen', type: 'other', amount: 15.75, status: 'open', created: '2024-01-15', description: 'Special instructions not followed' }
  ];

  function renderDisputes(data) {
    const tbody = document.getElementById('disputesTable');
    tbody.innerHTML = data.map(dispute => {
      let statusClass = 'status-open';
      if (dispute.status === 'investigating') statusClass = 'status-investigating';
      if (dispute.status === 'resolved') statusClass = 'status-resolved';
      if (dispute.status === 'rejected') statusClass = 'status-rejected';
      
      return `
        <tr>
          <td><strong>${dispute.id}</strong></td>
          <td>${dispute.orderId}</td>
          <td>${dispute.customer}</td>
          <td>${dispute.type.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</td>
          <td>$${dispute.amount.toFixed(2)}</td>
          <td><span class="status-badge ${statusClass}">${dispute.status.toUpperCase()}</span></td>
          <td>${new Date(dispute.created).toLocaleDateString()}</td>
          <td>
            <button class="action-btn-sm" onclick="viewDispute('${dispute.id}')">View</button>
            ${dispute.status === 'open' ? '<button class="action-btn-sm" onclick="resolveDispute(\'' + dispute.id + '\')">Resolve</button>' : ''}
          </td>
        </tr>
      `;
    }).join('');
  }

  window.viewDispute = function(id) {
    const dispute = disputes.find(d => d.id === id);
    if (!dispute) return;

    const detailPanel = document.getElementById('disputeDetail');
    const content = document.getElementById('disputeContent');

    content.innerHTML = `
      <div class="dispute-info">
        <div class="info-item">
          <div class="info-label">Dispute ID</div>
          <div class="info-value">${dispute.id}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Order ID</div>
          <div class="info-value">${dispute.orderId}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Customer</div>
          <div class="info-value">${dispute.customer}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Type</div>
          <div class="info-value">${dispute.type}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Amount</div>
          <div class="info-value">$${dispute.amount.toFixed(2)}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Status</div>
          <div class="info-value">${dispute.status}</div>
        </div>
      </div>
      <div style="margin-top: 24px;">
        <h4>Description</h4>
        <p>${dispute.description}</p>
      </div>
      ${dispute.status === 'open' ? `
        <div style="margin-top: 24px; display: flex; gap: 12px;">
          <button class="button button--primary" onclick="resolveDispute('${dispute.id}')">Resolve & Refund</button>
          <button class="button" onclick="rejectDispute('${dispute.id}')">Reject</button>
        </div>
      ` : ''}
    `;

    detailPanel.style.display = 'block';
    detailPanel.scrollIntoView({ behavior: 'smooth' });
  };

  window.closeDetail = function() {
    document.getElementById('disputeDetail').style.display = 'none';
  };

  window.resolveDispute = function(id) {
    const dispute = disputes.find(d => d.id === id);
    if (dispute) {
      dispute.status = 'resolved';
      renderDisputes(disputes);
      closeDetail();
      alert(`Dispute ${id} has been resolved and refunded.`);
    }
  };

  window.rejectDispute = function(id) {
    const dispute = disputes.find(d => d.id === id);
    if (dispute) {
      dispute.status = 'rejected';
      renderDisputes(disputes);
      closeDetail();
      alert(`Dispute ${id} has been rejected.`);
    }
  };

  // Filter handlers
  document.getElementById('statusFilter').addEventListener('change', filterDisputes);
  document.getElementById('typeFilter').addEventListener('change', filterDisputes);

  function filterDisputes() {
    const status = document.getElementById('statusFilter').value.toLowerCase();
    const type = document.getElementById('typeFilter').value.toLowerCase();
    
    let filtered = disputes;
    if (status) filtered = filtered.filter(d => d.status === status);
    if (type) filtered = filtered.filter(d => d.type === type);
    
    renderDisputes(filtered);
  }

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await window.apiFetch('/api/auth/logout', { method: 'POST' });
    navigateTo('/');
  });

  renderDisputes(disputes);
})();
</script>

