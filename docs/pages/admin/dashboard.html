<!-- Admin Dashboard Content -->
<div class="page-header">
  <h1 class="page-header__title">Admin Dashboard</h1>
  <p class="page-header__subtitle">Manage your platform from this central dashboard</p>
</div>

<!-- Metrics Section -->
<section class="section">
  <div class="grid grid--4">
    <div class="metric-card">
      <div class="metric-card__label">Orders Today</div>
      <div class="metric-card__value" id="ordersToday">-</div>
      <div class="metric-card__change metric-card__change--positive" id="ordersChange">-</div>
    </div>
    <div class="metric-card">
      <div class="metric-card__label">Revenue Today</div>
      <div class="metric-card__value" id="revenueToday">$-</div>
      <div class="metric-card__change metric-card__change--positive" id="revenueChange">-</div>
    </div>
    <div class="metric-card">
      <div class="metric-card__label">Active Drivers</div>
      <div class="metric-card__value" id="activeDrivers">-</div>
    </div>
    <div class="metric-card">
      <div class="metric-card__label">Chefs Online</div>
      <div class="metric-card__value" id="chefsOnline">-</div>
    </div>
  </div>
</section>

<!-- Order Pipeline -->
<section class="section">
  <div class="section__header">
    <h2 class="section__title">Order Pipeline</h2>
  </div>
  <div class="card">
    <div class="card__body">
      <div class="grid grid--4">
        <div class="pipeline-stage">
          <div class="pipeline-stage__header">
            <span class="badge badge--pending">Pending</span>
            <span class="pipeline-stage__count" id="pipelinePending">0</span>
          </div>
        </div>
        <div class="pipeline-stage">
          <div class="pipeline-stage__header">
            <span class="badge badge--preparing">Preparing</span>
            <span class="pipeline-stage__count" id="pipelinePreparing">0</span>
          </div>
        </div>
        <div class="pipeline-stage">
          <div class="pipeline-stage__header">
            <span class="badge badge--picked-up">In Transit</span>
            <span class="pipeline-stage__count" id="pipelineTransit">0</span>
          </div>
        </div>
        <div class="pipeline-stage">
          <div class="pipeline-stage__header">
            <span class="badge badge--delivered">Delivered</span>
            <span class="pipeline-stage__count" id="pipelineDelivered">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Latest Orders -->
<section class="section">
  <div class="section__header">
    <h2 class="section__title">Latest Orders</h2>
    <div class="section__actions">
      <button class="button button--sm button--outline" onclick="navigateTo('/admin/operations')">
        View All Orders
      </button>
    </div>
  </div>
  <div class="card">
    <div class="card__body p-0">
      <table class="table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Chef</th>
            <th>Total</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="latestOrdersTable">
          <tr>
            <td colspan="6" class="text-center text-muted">Loading orders...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Activity Feed -->
<section class="section">
  <div class="section__header">
    <h2 class="section__title">Recent Activity</h2>
  </div>
  <div class="card">
    <div class="card__body">
      <div id="activityFeed" class="activity-feed">
        <div class="text-center text-muted">Loading activity...</div>
      </div>
    </div>
  </div>
</section>

<style>
.pipeline-stage {
  text-align: center;
}

.pipeline-stage__header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-3);
}

.pipeline-stage__count {
  font-size: var(--font-size-3xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-text);
}

.activity-feed {
  display: flex;
  flex-direction: column;
  gap: var(--space-4);
}

.activity-item {
  display: flex;
  gap: var(--space-3);
  padding-bottom: var(--space-4);
  border-bottom: 1px solid var(--color-border-light);
}

.activity-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.activity-item__icon {
  flex-shrink: 0;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--color-primary-light);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-size-lg);
}

.activity-item__content {
  flex: 1;
}

.activity-item__title {
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-1);
}

.activity-item__time {
  font-size: var(--font-size-sm);
  color: var(--color-text-muted);
}
</style>

<script>
(async function() {
  // Initialize demo mode
  const isDemoMode = window.AppConfig?.demoMode || false;
  
  if (isDemoMode) {
    // Seed demo data if not already seeded
    try {
      await window.apiFetch('/api/demo/seed', { method: 'POST' });
    } catch (error) {
      console.error('Failed to seed demo data:', error);
    }
  }
  
  // Fetch and display metrics
  async function loadMetrics() {
    try {
      if (isDemoMode) {
        const res = await window.apiFetch('/api/demo/data');
        const data = await res.json();
        
        // Calculate metrics from demo data
        const todayOrders = data.orders.filter(o => {
          const orderDate = new Date(o.createdAt);
          const today = new Date();
          return orderDate.toDateString() === today.toDateString();
        });
        
        const todayRevenue = todayOrders.reduce((sum, o) => sum + parseFloat(o.total), 0);
        const activeDrivers = data.drivers.filter(d => d.status === 'available').length;
        const chefsOnline = data.chefs.filter(c => c.status === 'active').length;
        
        document.getElementById('ordersToday').textContent = todayOrders.length;
        document.getElementById('revenueToday').textContent = `$${todayRevenue.toFixed(2)}`;
        document.getElementById('activeDrivers').textContent = activeDrivers;
        document.getElementById('chefsOnline').textContent = chefsOnline;
        
        document.getElementById('ordersChange').textContent = '+12% from yesterday';
        document.getElementById('revenueChange').textContent = '+8% from yesterday';
        
        // Update pipeline
        const statusCounts = {
          pending: 0,
          preparing: 0,
          picked_up: 0,
          delivered: 0
        };
        
        data.orders.forEach(o => {
          if (o.status === 'pending' || o.status === 'paid') {
            statusCounts.pending++;
          } else if (o.status === 'preparing' || o.status === 'ready') {
            statusCounts.preparing++;
          } else if (o.status === 'picked_up') {
            statusCounts.picked_up++;
          } else if (o.status === 'delivered') {
            statusCounts.delivered++;
          }
        });
        
        document.getElementById('pipelinePending').textContent = statusCounts.pending;
        document.getElementById('pipelinePreparing').textContent = statusCounts.preparing;
        document.getElementById('pipelineTransit').textContent = statusCounts.picked_up;
        document.getElementById('pipelineDelivered').textContent = statusCounts.delivered;
        
        // Load latest orders
        loadLatestOrders(data.orders);
        
        // Load activity feed
        loadActivityFeed(data.orders);
      }
    } catch (error) {
      console.error('Failed to load metrics:', error);
    }
  }
  
  // Load latest orders
  function loadLatestOrders(orders) {
    const tbody = document.getElementById('latestOrdersTable');
    
    if (!orders || orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No orders found</td></tr>';
      return;
    }
    
    // Get latest 5 orders
    const latestOrders = orders
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
      .slice(0, 5);
    
    tbody.innerHTML = latestOrders.map(order => {
      const customer = order.customer || { name: 'Unknown' };
      const chef = order.chef || { name: 'Unknown' };
      
      return `
        <tr>
          <td class="font-medium">#${order.id.substring(order.id.length - 6)}</td>
          <td>${customer.name}</td>
          <td>${chef.name}</td>
          <td class="font-semibold">$${parseFloat(order.total).toFixed(2)}</td>
          <td><span class="badge badge--${order.status}">${order.status}</span></td>
          <td>
            ${order.status !== 'delivered' && isDemoMode ? `
              <button 
                class="button button--sm button--outline" 
                onclick="advanceOrder('${order.id}')"
              >
                Advance
              </button>
            ` : '-'}
          </td>
        </tr>
      `;
    }).join('');
  }
  
  // Load activity feed
  function loadActivityFeed(orders) {
    const feed = document.getElementById('activityFeed');
    
    if (!orders || orders.length === 0) {
      feed.innerHTML = '<div class="text-center text-muted">No recent activity</div>';
      return;
    }
    
    // Get recent activities (last 5 order updates)
    const recentOrders = orders
      .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
      .slice(0, 5);
    
    feed.innerHTML = recentOrders.map(order => {
      const timeAgo = getTimeAgo(new Date(order.updatedAt));
      const customer = order.customer || { name: 'Unknown' };
      
      return `
        <div class="activity-item">
          <div class="activity-item__icon">ðŸ“¦</div>
          <div class="activity-item__content">
            <div class="activity-item__title">
              Order #${order.id.substring(order.id.length - 6)} - ${order.status}
            </div>
            <div class="activity-item__time">
              ${customer.name} â€¢ ${timeAgo}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }
  
  // Helper: Get time ago string
  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
    return `${Math.floor(seconds / 86400)} days ago`;
  }
  
  // Advance order (demo mode only)
  window.advanceOrder = async function(orderId) {
    try {
      const res = await window.apiFetch(`/api/demo/advance-order/${orderId}`, {
        method: 'POST'
      });
      const data = await res.json();
      
      if (data.success) {
        // Reload metrics and orders
        loadMetrics();
      } else {
        alert('Failed to advance order: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Failed to advance order:', error);
      alert('Failed to advance order');
    }
  };
  
  // Load initial data
  loadMetrics();
  
  // Refresh every 30 seconds in demo mode
  if (isDemoMode) {
    setInterval(loadMetrics, 30000);
  }
})();
</script>
