<!-- Driver Simulator -->
<div class="admin-layout">
  <aside class="admin-sidebar">
    <div class="admin-brand">
      <h2>ðŸ” Admin Portal</h2>
    </div>
    <nav class="admin-nav">
      <a href="#" onclick="navigateTo('/admin'); return false;">ðŸ“Š Dashboard</a>
      <a href="#" onclick="navigateTo('/admin/customers'); return false;">ðŸ‘¥ Customers</a>
      <a href="#" onclick="navigateTo('/admin/drivers'); return false;">ðŸš— Drivers</a>
      <a href="#" onclick="navigateTo('/admin/operations'); return false;">ðŸ“¦ Operations</a>
      <a href="#" onclick="navigateTo('/admin/payouts'); return false;">ðŸ’° Payouts</a>
      <a href="#" onclick="navigateTo('/admin/disputes'); return false;">âš ï¸ Disputes</a>
      <a href="#" onclick="navigateTo('/admin/integrations'); return false;">ðŸ”Œ Integrations</a>
      <a href="#" onclick="navigateTo('/admin/live-map'); return false;">ðŸ—ºï¸ Live Map</a>
      <a href="#" onclick="navigateTo('/admin/driver-simulator'); return false;" class="active">ðŸŽ® Simulator</a>
      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 12px 0;">
      <a href="#" onclick="navigateTo('/admin/legal/terms'); return false;">ðŸ“„ Terms</a>
      <a href="#" onclick="navigateTo('/admin/legal/privacy'); return false;">ðŸ”’ Privacy</a>
    </nav>
  </aside>

  <main class="admin-main">
    <header class="admin-header">
      <h1>ðŸŽ® Driver Simulator</h1>
      <button id="logoutBtn" class="button">Logout</button>
    </header>

    <div class="admin-content">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <div class="sim-panel">
          <h3>Driver Controls</h3>
          
          <div class="control-group">
            <label>Select Driver</label>
            <select id="driverSelect" class="control-input">
              <option value="driver-1">Driver 1</option>
              <option value="driver-2">Driver 2</option>
              <option value="driver-3">Driver 3</option>
            </select>
          </div>

          <div class="control-group">
            <label>Current Status</label>
            <div id="currentStatus" style="padding: 12px; background: var(--sand); border-radius: 8px; font-weight: 600;">
              Available
            </div>
          </div>

          <div class="control-group">
            <label>Move to Location</label>
            <select id="locationSelect" class="control-input">
              <option value="">Select Location</option>
              <option value="base">RideNDine Base</option>
              <option value="point-1">Delivery Point 1</option>
              <option value="point-2">Delivery Point 2</option>
              <option value="point-3">Delivery Point 3</option>
              <option value="point-4">Delivery Point 4</option>
            </select>
            <button class="button button--primary" onclick="moveDriver()" style="width: 100%; margin-top: 8px;">
              ðŸ“ Move Driver
            </button>
          </div>

          <div class="control-group">
            <label>Order Status Actions</label>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button class="sim-btn" onclick="updateStatus('picked_up')">ðŸ“¦ Mark as Picked Up</button>
              <button class="sim-btn" onclick="updateStatus('en_route')">ðŸš— Mark as En Route</button>
              <button class="sim-btn" onclick="updateStatus('arrived')">ðŸ“ Mark as Arrived</button>
              <button class="sim-btn" onclick="updateStatus('delivered')">âœ… Mark as Delivered</button>
            </div>
          </div>

          <div class="control-group">
            <label>Driver Actions</label>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button class="sim-btn" onclick="goOnline()">ðŸŸ¢ Go Online</button>
              <button class="sim-btn" onclick="goOffline()">ðŸ”´ Go Offline</button>
              <button class="sim-btn" onclick="requestBreak()">â˜• Request Break</button>
            </div>
          </div>
        </div>

        <div class="sim-panel">
          <h3>ðŸ—ºï¸ Live Map View</h3>
          <div id="miniMap" style="height: 400px; border-radius: 8px; overflow: hidden;"></div>
          
          <div style="margin-top: 16px;">
            <button class="button button--primary" onclick="navigateTo('/admin/live-map')" style="width: 100%;">
              Open Full Map View
            </button>
          </div>
        </div>
      </div>

      <div class="sim-panel" style="margin-top: 24px;">
        <h3>ðŸ“Š Simulation Log</h3>
        <div id="simLog" style="background: #1a202c; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 0.875rem; max-height: 200px; overflow-y: auto;">
          <div>[System] Driver simulator ready</div>
        </div>
      </div>
    </div>
  </main>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  .admin-layout { display: flex; min-height: 100vh; }
  .admin-sidebar { width: 250px; background: #1a202c; color: white; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
  .admin-brand h2 { margin: 0 0 24px 0; font-size: 1.2rem; }
  .admin-nav { display: flex; flex-direction: column; gap: 4px; }
  .admin-nav a { padding: 10px 12px; border-radius: 6px; color: #cbd5e0; transition: all 0.2s; }
  .admin-nav a:hover, .admin-nav a.active { background: #2d3748; color: white; }
  .admin-main { margin-left: 250px; flex: 1; background: var(--sand); }
  .admin-header { background: white; padding: 20px 32px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .admin-header h1 { margin: 0; }
  .admin-content { padding: 32px; }
  .sim-panel { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .sim-panel h3 { margin-top: 0; }
  .control-group { margin-bottom: 20px; }
  .control-group label { display: block; font-weight: 600; margin-bottom: 8px; }
  .control-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
  .sim-btn { padding: 12px; background: var(--teal); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
  .sim-btn:hover { background: var(--teal-dark); }
</style>

<script>
(async function() {
  // Check admin authentication
  try {
    const res = await window.apiFetch('/api/auth/session');
    const data = await res.json();
    if (!data.authenticated || data.role !== 'admin') {
      navigateTo('/admin/login');
      return;
    }
  } catch (error) {
    navigateTo('/admin/login');
    return;
  }

  // Initialize mini map
  const base = [43.2238, -79.7654];
  const dropPoints = [
    [43.2339, -79.7481],
    [43.2444, -79.7812],
    [43.2172, -79.8024],
    [43.2318, -79.7708],
  ];

  const miniMap = L.map("miniMap", {
    zoomControl: true,
    scrollWheelZoom: false,
  }).setView(base, 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap",
  }).addTo(miniMap);

  // Add base marker
  L.marker(base).addTo(miniMap).bindPopup("RideNDine Base");

  // Add delivery points
  dropPoints.forEach((point, i) => {
    L.circleMarker(point, {
      radius: 6,
      color: "#ff7a18",
      fillColor: "#ff7a18",
      fillOpacity: 0.8,
    }).addTo(miniMap).bindPopup(`Point ${i + 1}`);
  });

  // Current driver marker
  let currentDriverMarker = L.circleMarker(base, {
    radius: 10,
    color: "#19b7b1",
    fillColor: "#19b7b1",
    fillOpacity: 1,
  }).addTo(miniMap).bindPopup("Driver 1");

  const locations = {
    'base': base,
    'point-1': dropPoints[0],
    'point-2': dropPoints[1],
    'point-3': dropPoints[2],
    'point-4': dropPoints[3]
  };

  function log(message) {
    const logDiv = document.getElementById('simLog');
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.textContent = `[${time}] ${message}`;
    logDiv.appendChild(entry);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  window.moveDriver = function() {
    const driver = document.getElementById('driverSelect').value;
    const location = document.getElementById('locationSelect').value;
    
    if (!location) {
      alert('Please select a location');
      return;
    }

    const coords = locations[location];
    currentDriverMarker.setLatLng(coords);
    miniMap.setView(coords, 14);
    
    log(`${driver} moved to ${location}`);
  };

  window.updateStatus = function(status) {
    const driver = document.getElementById('driverSelect').value;
    const statusText = status.replace('_', ' ').toUpperCase();
    
    document.getElementById('currentStatus').textContent = statusText;
    log(`${driver} status updated to: ${statusText}`);
  };

  window.goOnline = function() {
    const driver = document.getElementById('driverSelect').value;
    document.getElementById('currentStatus').textContent = 'ONLINE';
    log(`${driver} is now ONLINE`);
  };

  window.goOffline = function() {
    const driver = document.getElementById('driverSelect').value;
    document.getElementById('currentStatus').textContent = 'OFFLINE';
    log(`${driver} is now OFFLINE`);
  };

  window.requestBreak = function() {
    const driver = document.getElementById('driverSelect').value;
    document.getElementById('currentStatus').textContent = 'ON BREAK';
    log(`${driver} requested a break`);
  };

  // Update driver selection
  document.getElementById('driverSelect').addEventListener('change', (e) => {
    const driver = e.target.value;
    currentDriverMarker.setPopupContent(driver.replace('-', ' ').toUpperCase());
    log(`Selected ${driver}`);
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await window.apiFetch('/api/auth/logout', { method: 'POST' });
    navigateTo('/');
  });

  setTimeout(() => miniMap.invalidateSize(), 100);
})();
</script>

