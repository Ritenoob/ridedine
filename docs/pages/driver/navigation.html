<!-- Driver Navigation -->
<style>
  body {
    margin: 0;
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
  }
  .driver-app {
    max-width: 600px;
    margin: 0 auto;
    background: var(--sand);
    min-height: 100vh;
  }
  .nav-header {
    background: linear-gradient(135deg, var(--orange) 0%, var(--orange-dark) 100%);
    color: white;
    padding: 16px 20px;
  }
  .nav-header h1 {
    margin: 0 0 8px 0;
    font-size: 1.25rem;
  }
  .eta-display {
    font-size: 2rem;
    font-weight: bold;
  }
  .map-container {
    width: 100%;
    height: 300px;
    background: #e2e8f0;
    position: relative;
    overflow: hidden;
  }
  #map {
    width: 100%;
    height: 100%;
  }
  .map-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .nav-content {
    padding: 20px;
  }
  .status-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 16px;
  }
  .status-badge {
    display: inline-block;
    padding: 6px 12px;
    background: #d1fae5;
    color: #065f46;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 12px;
  }
  .directions-list {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 16px;
  }
  .directions-list h3 {
    margin: 0 0 16px 0;
    color: var(--ink);
  }
  .direction-step {
    display: flex;
    gap: 16px;
    padding: 12px 0;
    border-bottom: 1px solid #e2e8f0;
  }
  .direction-step:last-child {
    border-bottom: none;
  }
  .step-icon {
    font-size: 1.5rem;
    width: 32px;
    text-align: center;
  }
  .step-text {
    flex: 1;
  }
  .step-distance {
    color: var(--muted);
    font-size: 0.875rem;
  }
  .delivery-info {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 16px;
  }
  .info-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
  }
  .info-row:last-child {
    border-bottom: none;
  }
  .info-label {
    color: var(--muted);
    font-size: 0.875rem;
  }
  .info-value {
    font-weight: 600;
    color: var(--ink);
  }
  .button {
    padding: 14px 24px;
    background: var(--orange);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
    width: 100%;
    font-size: 1rem;
  }
  .button:hover {
    background: var(--orange-dark);
  }
  .button-success {
    background: var(--teal);
  }
  .button-success:hover {
    background: var(--teal-dark);
  }
  .button-secondary {
    background: white;
    color: var(--orange);
    border: 2px solid var(--orange);
    margin-top: 12px;
  }
  .button-secondary:hover {
    background: #fff5f0;
  }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="driver-app">
  <header class="nav-header">
    <h1>ðŸ—ºï¸ Navigation</h1>
    <div class="eta-display" id="etaDisplay">15 mins</div>
    <div style="font-size: 0.875rem; opacity: 0.9;">Estimated time of arrival</div>
  </header>

  <div class="map-container">
    <div id="map"></div>
  </div>

  <div class="nav-content">
    <div class="status-card">
      <div class="status-badge" id="statusBadge">ðŸš— En Route to Pickup</div>
      <div style="color: var(--muted); font-size: 0.875rem; margin-top: 8px;" id="currentAddress">
        Heading to restaurant...
      </div>
    </div>

    <div class="delivery-info">
      <h3 style="margin: 0 0 12px 0;">Delivery Details</h3>
      <div class="info-row">
        <div class="info-label">Order #</div>
        <div class="info-value" id="orderId">-</div>
      </div>
      <div class="info-row">
        <div class="info-label">Pickup</div>
        <div class="info-value" id="pickupAddress">-</div>
      </div>
      <div class="info-row">
        <div class="info-label">Drop-off</div>
        <div class="info-value" id="dropoffAddress">-</div>
      </div>
      <div class="info-row">
        <div class="info-label">Distance</div>
        <div class="info-value" id="distance">-</div>
      </div>
      <div class="info-row">
        <div class="info-label">Payment</div>
        <div class="info-value" id="payment">-</div>
      </div>
    </div>

    <div class="directions-list">
      <h3>ðŸ“ Directions</h3>
      <div id="directionSteps">
        <!-- Will be populated with turn-by-turn directions -->
      </div>
    </div>

    <button class="button button-success" id="actionBtn" onclick="handleAction()">
      Picked Up Order
    </button>
    <button class="button button-secondary" onclick="navigateTo('/driver/jobs')">
      â† Back to Jobs
    </button>
  </div>
</div>

<script>
let deliveryData = null;
let currentStatus = 'en_route_to_pickup';
let map = null;

(async function() {
  // Check authentication
  try {
    const res = await window.apiFetch('/api/auth/session');
    const data = await res.json();
    
    if (!data.demoMode && (!data.authenticated || data.role !== 'driver')) {
      navigateTo('/driver/login');
      return;
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    navigateTo('/driver/login');
    return;
  }

  // Get job ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const jobId = urlParams.get('jobId');

  if (!jobId) {
    alert('No job ID provided');
    navigateTo('/driver/jobs');
    return;
  }

  // Load delivery data
  loadDeliveryData(jobId);

  // Initialize map
  initMap();
})();

function loadDeliveryData(jobId) {
  // Get from localStorage or use mock data
  const activeDelivery = localStorage.getItem('driverActiveDelivery');
  
  if (activeDelivery) {
    deliveryData = JSON.parse(activeDelivery);
  } else {
    // Mock data
    deliveryData = {
      jobId: jobId,
      orderId: '12345',
      pickupAddress: '123 Main St, Pizzeria Roma',
      dropoffAddress: '456 Oak Ave, Apt 2B',
      distance: '2.5 mi',
      estimatedTime: '15 mins',
      pay: 8.50,
      status: 'en_route_to_pickup'
    };
    localStorage.setItem('driverActiveDelivery', JSON.stringify(deliveryData));
  }

  currentStatus = deliveryData.status || 'en_route_to_pickup';

  // Update UI
  document.getElementById('orderId').textContent = deliveryData.orderId || 'N/A';
  document.getElementById('pickupAddress').textContent = deliveryData.pickupAddress || 'N/A';
  document.getElementById('dropoffAddress').textContent = deliveryData.dropoffAddress || 'N/A';
  document.getElementById('distance').textContent = deliveryData.distance || 'N/A';
  document.getElementById('payment').textContent = `$${(deliveryData.pay || 0).toFixed(2)}`;
  document.getElementById('etaDisplay').textContent = deliveryData.eta || deliveryData.estimatedTime || 'Calculating...';

  updateStatus();
  loadDirections();
}

function initMap() {
  try {
    // Initialize Leaflet map
    map = L.map('map').setView([37.7749, -122.4194], 13); // San Francisco coords

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Add markers for pickup and dropoff
    const pickupMarker = L.marker([37.7749, -122.4194]).addTo(map);
    pickupMarker.bindPopup('<b>Pickup Location</b><br>' + (deliveryData?.pickupAddress || 'Restaurant'));

    const dropoffMarker = L.marker([37.7849, -122.4094]).addTo(map);
    dropoffMarker.bindPopup('<b>Drop-off Location</b><br>' + (deliveryData?.dropoffAddress || 'Customer'));

    // Draw a line between them
    const route = L.polyline([
      [37.7749, -122.4194],
      [37.7849, -122.4094]
    ], {color: 'var(--orange)', weight: 4}).addTo(map);

    // Fit map to show both markers
    map.fitBounds(route.getBounds(), {padding: [50, 50]});
  } catch (error) {
    console.error('Failed to initialize map:', error);
    document.getElementById('map').innerHTML = `
      <div class="map-placeholder">
        <div style="font-size: 3rem;">ðŸ—ºï¸</div>
        <div style="margin-top: 12px;">Map View</div>
        <div style="font-size: 0.875rem; opacity: 0.8; margin-top: 4px;">Route displayed here</div>
      </div>
    `;
  }
}

function loadDirections() {
  // Mock turn-by-turn directions
  const directions = currentStatus === 'en_route_to_pickup' ? [
    { icon: 'â¬†ï¸', text: 'Head north on Main St', distance: '0.5 mi' },
    { icon: 'âž¡ï¸', text: 'Turn right onto Oak Ave', distance: '0.3 mi' },
    { icon: 'â¬†ï¸', text: 'Continue straight', distance: '1.2 mi' },
    { icon: 'ðŸ“', text: 'Arrive at pickup location', distance: '' }
  ] : [
    { icon: 'â¬†ï¸', text: 'Head south on Main St', distance: '0.8 mi' },
    { icon: 'â¬…ï¸', text: 'Turn left onto Pine St', distance: '0.5 mi' },
    { icon: 'âž¡ï¸', text: 'Turn right onto Customer Ave', distance: '0.2 mi' },
    { icon: 'ðŸ ', text: 'Arrive at drop-off location', distance: '' }
  ];

  const stepsHtml = directions.map(step => `
    <div class="direction-step">
      <div class="step-icon">${step.icon}</div>
      <div class="step-text">
        <div>${step.text}</div>
        ${step.distance ? `<div class="step-distance">${step.distance}</div>` : ''}
      </div>
    </div>
  `).join('');

  document.getElementById('directionSteps').innerHTML = stepsHtml;
}

function updateStatus() {
  const statusBadge = document.getElementById('statusBadge');
  const currentAddress = document.getElementById('currentAddress');
  const actionBtn = document.getElementById('actionBtn');

  if (currentStatus === 'en_route_to_pickup') {
    statusBadge.textContent = 'ðŸš— En Route to Pickup';
    currentAddress.textContent = 'Heading to ' + deliveryData.pickupAddress;
    actionBtn.textContent = 'Picked Up Order';
    actionBtn.className = 'button button-success';
  } else if (currentStatus === 'en_route_to_customer') {
    statusBadge.textContent = 'ðŸ“¦ En Route to Customer';
    currentAddress.textContent = 'Delivering to ' + deliveryData.dropoffAddress;
    actionBtn.textContent = 'Mark as Delivered';
    actionBtn.className = 'button button-success';
  }
}

function handleAction() {
  if (currentStatus === 'en_route_to_pickup') {
    // Mark as picked up, now en route to customer
    currentStatus = 'en_route_to_customer';
    deliveryData.status = currentStatus;
    localStorage.setItem('driverActiveDelivery', JSON.stringify(deliveryData));
    updateStatus();
    loadDirections();
    
    // Update map to show route to customer
    if (map) {
      map.setView([37.7849, -122.4094], 14);
    }
  } else if (currentStatus === 'en_route_to_customer') {
    // Navigate to proof of delivery
    navigateTo(`/driver/pod/${deliveryData.jobId}`);
  }
}
</script>

