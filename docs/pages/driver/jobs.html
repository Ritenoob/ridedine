<!-- Driver Jobs Content -->
<div class="page-header">
  <h1 class="page-header__title">Available Jobs</h1>
  <p class="page-header__subtitle">View and manage your delivery jobs</p>
</div>

<!-- Quick Stats -->
<section class="section">
  <div class="grid grid--3">
    <div class="metric-card">
      <div class="metric-card__label">Available Jobs</div>
      <div class="metric-card__value" id="availableJobs">-</div>
    </div>
    <div class="metric-card">
      <div class="metric-card__label">My Active Jobs</div>
      <div class="metric-card__value" id="activeJobs">-</div>
    </div>
    <div class="metric-card">
      <div class="metric-card__label">Completed Today</div>
      <div class="metric-card__value" id="completedToday">-</div>
    </div>
  </div>
</section>

<!-- My Active Deliveries -->
<section class="section" id="myJobsSection" style="display: none;">
  <div class="section__header">
    <h2 class="section__title">My Active Deliveries</h2>
  </div>
  <div id="myJobsContainer" class="grid grid--2">
  </div>
</section>

<!-- Available Jobs -->
<section class="section">
  <div class="section__header">
    <h2 class="section__title">Available Jobs</h2>
    <button class="button button--sm button--primary" onclick="refreshJobs()">
      üîÑ Refresh
    </button>
  </div>
  <div id="jobsContainer" class="grid grid--2">
    <div class="card">
      <div class="card__body text-center text-muted">
        Loading jobs...
      </div>
    </div>
  </div>
</section>

<style>
.job-card {
  background: var(--color-surface);
  border-radius: var(--radius-xl);
  border: 2px solid var(--color-border);
  overflow: hidden;
  transition: all var(--transition-base);
}

.job-card:hover {
  border-color: var(--color-secondary);
  box-shadow: var(--shadow-lg);
}

.job-card--active {
  border-color: var(--color-primary);
  background: var(--color-primary-light);
}

.job-card__header {
  padding: var(--space-4);
  background: var(--color-background);
  border-bottom: 1px solid var(--color-border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.job-card__id {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-bold);
  color: var(--color-text);
}

.job-card__body {
  padding: var(--space-4);
}

.job-location {
  display: flex;
  gap: var(--space-2);
  margin-bottom: var(--space-3);
  padding: var(--space-3);
  background: var(--color-background);
  border-radius: var(--radius-lg);
}

.job-location__icon {
  font-size: var(--font-size-xl);
}

.job-location__details {
  flex: 1;
}

.job-location__label {
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
  text-transform: uppercase;
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-1);
}

.job-location__address {
  font-size: var(--font-size-sm);
  color: var(--color-text);
}

.job-info {
  display: flex;
  gap: var(--space-4);
  margin-top: var(--space-3);
  padding-top: var(--space-3);
  border-top: 1px solid var(--color-border-light);
}

.job-info__item {
  font-size: var(--font-size-sm);
}

.job-info__label {
  color: var(--color-text-muted);
  margin-bottom: var(--space-1);
}

.job-info__value {
  font-weight: var(--font-weight-semibold);
  color: var(--color-text);
}

.job-card__footer {
  padding: var(--space-4);
  background: var(--color-background);
  border-top: 1px solid var(--color-border-light);
  display: flex;
  gap: var(--space-2);
  justify-content: space-between;
  align-items: center;
}

.job-card__earnings {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-success);
}
</style>

<script>
(async function() {
  const isDemoMode = window.AppConfig?.demoMode || false;
  const driverId = window.AppConfig?.currentUser || 'driver_3000'; // Default to first driver
  
  // Load jobs
  async function loadJobs() {
    try {
      if (isDemoMode) {
        const res = await window.apiFetch('/api/demo/orders');
        const data = await res.json();
        
        // Update metrics
        updateMetrics(data.orders, driverId);
        
        // Display jobs
        displayJobs(data.orders, driverId);
      }
    } catch (error) {
      console.error('Failed to load jobs:', error);
      document.getElementById('jobsContainer').innerHTML = `
        <div class="card">
          <div class="card__body text-center text-error">
            Failed to load jobs
          </div>
        </div>
      `;
    }
  }
  
  // Update metrics
  function updateMetrics(orders, currentDriverId) {
    const available = orders.filter(o => 
      o.status === 'ready' && !o.driverId
    ).length;
    
    const active = orders.filter(o => 
      o.driverId === currentDriverId && o.status === 'picked_up'
    ).length;
    
    const today = new Date().toDateString();
    const completed = orders.filter(o => {
      const orderDate = new Date(o.createdAt).toDateString();
      return orderDate === today && o.driverId === currentDriverId && o.status === 'delivered';
    }).length;
    
    document.getElementById('availableJobs').textContent = available;
    document.getElementById('activeJobs').textContent = active;
    document.getElementById('completedToday').textContent = completed;
  }
  
  // Display jobs
  function displayJobs(orders, currentDriverId) {
    const myJobsContainer = document.getElementById('myJobsContainer');
    const jobsContainer = document.getElementById('jobsContainer');
    const myJobsSection = document.getElementById('myJobsSection');
    
    // Separate my jobs and available jobs
    const myJobs = orders.filter(o => 
      o.driverId === currentDriverId && o.status === 'picked_up'
    );
    
    const availableJobs = orders.filter(o => 
      o.status === 'ready' && !o.driverId
    );
    
    // Display my active jobs
    if (myJobs.length > 0) {
      myJobsSection.style.display = 'block';
      myJobsContainer.innerHTML = myJobs.map(order => renderJobCard(order, true)).join('');
    } else {
      myJobsSection.style.display = 'none';
    }
    
    // Display available jobs
    if (availableJobs.length === 0) {
      jobsContainer.innerHTML = `
        <div class="card">
          <div class="card__body text-center text-muted">
            No jobs available at the moment
          </div>
        </div>
      `;
      return;
    }
    
    jobsContainer.innerHTML = availableJobs.map(order => renderJobCard(order, false)).join('');
  }
  
  // Render job card
  function renderJobCard(order, isMyJob) {
    const customer = order.customer || { name: 'Unknown', address: 'N/A' };
    const chef = order.chef || { name: 'Unknown' };
    const distance = (Math.random() * 5 + 1).toFixed(1); // Mock distance
    const earnings = (parseFloat(order.total) * 0.15).toFixed(2); // 15% commission
    
    return `
      <div class="job-card ${isMyJob ? 'job-card--active' : ''}">
        <div class="job-card__header">
          <div class="job-card__id">Order #${order.id.substring(order.id.length - 6)}</div>
          <span class="badge badge--${order.status}">${order.status}</span>
        </div>
        
        <div class="job-card__body">
          <div class="job-location">
            <div class="job-location__icon">üè†</div>
            <div class="job-location__details">
              <div class="job-location__label">Pickup From</div>
              <div class="job-location__address">${chef.name}</div>
            </div>
          </div>
          
          <div class="job-location">
            <div class="job-location__icon">üìç</div>
            <div class="job-location__details">
              <div class="job-location__label">Deliver To</div>
              <div class="job-location__address">${customer.name}<br>${customer.address}</div>
            </div>
          </div>
          
          <div class="job-info">
            <div class="job-info__item">
              <div class="job-info__label">Distance</div>
              <div class="job-info__value">${distance} km</div>
            </div>
            <div class="job-info__item">
              <div class="job-info__label">Order Value</div>
              <div class="job-info__value">$${parseFloat(order.total).toFixed(2)}</div>
            </div>
          </div>
        </div>
        
        <div class="job-card__footer">
          <div class="job-card__earnings">+$${earnings}</div>
          ${getJobActions(order, isMyJob)}
        </div>
      </div>
    `;
  }
  
  // Get job actions based on status
  function getJobActions(order, isMyJob) {
    if (!isDemoMode) return '';
    
    if (isMyJob) {
      return `
        <button 
          class="button button--sm button--success" 
          onclick="completeDelivery('${order.id}')"
        >
          ‚úì Complete Delivery
        </button>
      `;
    } else {
      return `
        <button 
          class="button button--sm button--primary" 
          onclick="acceptJob('${order.id}')"
        >
          Accept Job
        </button>
      `;
    }
  }
  
  // Accept job
  window.acceptJob = async function(orderId) {
    try {
      // In a real app, this would assign the driver
      // For demo, we'll just advance the order
      const res = await window.apiFetch(`/api/demo/advance-order/${orderId}`, {
        method: 'POST'
      });
      const data = await res.json();
      
      if (data.success) {
        loadJobs();
      } else {
        alert('Failed to accept job: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Failed to accept job:', error);
      alert('Failed to accept job');
    }
  };
  
  // Complete delivery
  window.completeDelivery = async function(orderId) {
    try {
      const res = await window.apiFetch(`/api/demo/advance-order/${orderId}`, {
        method: 'POST'
      });
      const data = await res.json();
      
      if (data.success) {
        loadJobs();
      } else {
        alert('Failed to complete delivery: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Failed to complete delivery:', error);
      alert('Failed to complete delivery');
    }
  };
  
  // Refresh jobs
  window.refreshJobs = function() {
    loadJobs();
  };
  
  // Load initial data
  loadJobs();
  
  // Auto-refresh every 30 seconds
  setInterval(loadJobs, 30000);
})();
</script>
