<!-- Chef Orders -->
<style>
  .chef-layout {
    display: flex;
    min-height: 100vh;
  }
  .chef-sidebar {
    width: 250px;
    background: white;
    border-right: 1px solid #e2e8f0;
    padding: 20px 0;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
  }
  .chef-brand {
    padding: 0 20px 20px;
    border-bottom: 1px solid #e2e8f0;
  }
  .chef-brand h2 {
    margin: 0;
    color: var(--teal);
    font-size: 1.5rem;
  }
  .chef-nav {
    padding: 20px 0;
  }
  .chef-nav a {
    display: block;
    padding: 12px 20px;
    color: var(--muted);
    transition: all 0.2s;
    border-left: 3px solid transparent;
  }
  .chef-nav a:hover, .chef-nav a.active {
    background: #f7fafc;
    color: var(--teal);
    border-left-color: var(--teal);
  }
  .chef-main {
    flex: 1;
    margin-left: 250px;
    background: var(--sand);
  }
  .chef-header {
    background: white;
    padding: 20px 32px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .chef-header h1 {
    margin: 0;
    font-size: 1.75rem;
  }
  .chef-content {
    padding: 32px;
  }
  .filters {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 24px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .filter-btn {
    padding: 8px 16px;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn.active {
    background: var(--teal);
    color: white;
    border-color: var(--teal);
  }
  .orders-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .order-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .order-id {
    font-weight: bold;
    color: var(--ink);
    font-size: 1.125rem;
  }
  .order-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
  }
  .status-pending {
    background: #fef3c7;
    color: #92400e;
  }
  .status-confirmed {
    background: #dbeafe;
    color: #1e40af;
  }
  .status-preparing {
    background: #fce7f3;
    color: #9f1239;
  }
  .status-ready {
    background: #d1fae5;
    color: #065f46;
  }
  .order-items {
    margin: 16px 0;
    padding: 16px;
    background: var(--sand);
    border-radius: 8px;
  }
  .order-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
  }
  .order-item:last-child {
    border-bottom: none;
  }
  .order-meta {
    display: flex;
    gap: 24px;
    margin-top: 16px;
    color: var(--muted);
    font-size: 0.875rem;
    flex-wrap: wrap;
  }
  .order-actions {
    margin-top: 16px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
  }
  .button-primary {
    background: var(--teal);
    color: white;
  }
  .button-primary:hover {
    background: var(--teal-dark);
  }
  .button-secondary {
    background: white;
    color: var(--teal);
    border: 2px solid var(--teal);
  }
  .button-secondary:hover {
    background: var(--sand);
  }
  .button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-state h3 {
    margin: 16px 0 8px;
    color: var(--ink);
  }

  @media (max-width: 768px) {
    .chef-sidebar {
      width: 200px;
    }
    .chef-main {
      margin-left: 200px;
    }
  }
</style>

<div class="chef-layout">
  <aside class="chef-sidebar">
    <div class="chef-brand">
      <h2>ðŸ‘¨â€ðŸ³ Chef Portal</h2>
    </div>
    <nav class="chef-nav">
      <a href="#" onclick="navigateTo('/chef-portal/dashboard'); return false;">ðŸ“Š Dashboard</a>
      <a href="#" onclick="navigateTo('/chef-portal/orders'); return false;" class="active">ðŸ“‹ Orders</a>
      <a href="#" onclick="navigateTo('/chef-portal/menu'); return false;">ðŸ½ï¸ Menu</a>
      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 12px 0;">
      <a href="#" onclick="handleLogout(); return false;">ðŸšª Logout</a>
    </nav>
  </aside>

  <main class="chef-main">
    <header class="chef-header">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; object-src 'none'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://unpkg.com; script-src 'self' 'unsafe-inline' https://unpkg.com; connect-src 'self' https://ridendine-demo.onrender.com; font-src 'self' data: https:;">
      <h1>Orders</h1>
      <button class="button button-primary" onclick="loadOrders()">ðŸ”„ Refresh</button>
    </header>

    <div class="chef-content">
      <div class="filters">
        <button class="filter-btn active" data-filter="all" onclick="filterOrders('all')">All Orders</button>
        <button class="filter-btn" data-filter="pending" onclick="filterOrders('pending')">Pending</button>
        <button class="filter-btn" data-filter="preparing" onclick="filterOrders('preparing')">Preparing</button>
        <button class="filter-btn" data-filter="ready" onclick="filterOrders('ready')">Ready</button>
      </div>

      <div id="ordersList" class="orders-list">
        <div class="empty-state">
          <div style="font-size: 3rem;">â³</div>
          <h3>Loading orders...</h3>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
let allOrders = [];
let currentFilter = 'all';

(async function() {
  // Check authentication
  try {
    const res = await window.apiFetch('/api/auth/session');
    const data = await res.json();
    
    if (!data.demoMode && (!data.authenticated || data.role !== 'chef')) {
      navigateTo('/chef-portal/login');
      return;
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    navigateTo('/chef-portal/login');
    return;
  }

  // Load initial orders
  await loadOrders();

  // Auto-refresh every 30 seconds
  setInterval(loadOrders, 30000);
})();

async function loadOrders() {
  try {
    const res = await window.apiFetch('/api/orders');
    const orders = await res.json();
    
    if (!Array.isArray(orders)) {
      console.warn('Orders is not an array:', orders);
      allOrders = [];
      renderOrders();
      return;
    }

    // Sort by creation time (newest first)
    allOrders = orders.sort((a, b) => {
      const aTime = new Date(a.createdAt || a.timestamp || 0);
      const bTime = new Date(b.createdAt || b.timestamp || 0);
      return bTime - aTime;
    });

    renderOrders();
  } catch (error) {
    console.error('Failed to load orders:', error);
    document.getElementById('ordersList').innerHTML = `
      <div class="empty-state">
        <div style="font-size: 3rem;">âš ï¸</div>
        <h3>Failed to load orders</h3>
        <p>${error.message}</p>
      </div>
    `;
  }
}

function filterOrders(filter) {
  currentFilter = filter;
  
  // Update active button
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.filter === filter);
  });

  renderOrders();
}

function renderOrders() {
  const container = document.getElementById('ordersList');
  
  // Filter orders
  let filteredOrders = allOrders;
  if (currentFilter !== 'all') {
    filteredOrders = allOrders.filter(order => {
      const status = order.status?.toLowerCase() || 'pending';
      if (currentFilter === 'pending') {
        return status === 'pending' || status === 'confirmed';
      }
      return status === currentFilter;
    });
  }

  if (filteredOrders.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div style="font-size: 3rem;">ðŸ“­</div>
        <h3>No ${currentFilter === 'all' ? '' : currentFilter} orders</h3>
        <p>Orders will appear here when customers place them</p>
      </div>
    `;
    return;
  }

  container.innerHTML = filteredOrders.map(order => {
    const status = order.status?.toLowerCase() || 'pending';
    const orderId = order.id || order.orderId || 'N/A';
    const items = order.items || [];
    const total = order.total || order.totalAmount || 0;
    const pickupTime = order.pickupTime || order.scheduledFor || 'ASAP';
    const customerName = order.customerName || 'Customer';
    
    // Redact customer name for privacy
    const nameParts = customerName.split(' ');
    const displayName = nameParts[0] + (nameParts[1] ? ' ' + nameParts[1][0] + '.' : '');

    return `
      <div class="order-card">
        <div class="order-header">
          <div>
            <div class="order-id">Order #${orderId}</div>
            <div style="color: var(--muted); font-size: 0.875rem; margin-top: 4px;">
              Customer: ${displayName}
            </div>
          </div>
          <span class="order-status status-${status}">${status.toUpperCase()}</span>
        </div>

        <div class="order-items">
          ${items.map(item => `
            <div class="order-item">
              <span>${item.quantity || 1}x ${item.name || item.item}</span>
              <span>$${(item.price || 0).toFixed(2)}</span>
            </div>
          `).join('')}
          <div class="order-item" style="font-weight: bold; margin-top: 8px; padding-top: 16px; border-top: 2px solid #cbd5e0;">
            <span>Total</span>
            <span>$${total.toFixed(2)}</span>
          </div>
        </div>

        <div class="order-meta">
          <div>â° Pickup: ${pickupTime}</div>
          <div>ðŸ“… ${new Date(order.createdAt || Date.now()).toLocaleString()}</div>
        </div>

        <div class="order-actions">
          ${status === 'pending' || status === 'confirmed' ? `
            <button class="button button-primary" onclick="updateOrderStatus('${orderId}', 'preparing')">
              Start Preparing
            </button>
          ` : ''}
          ${status === 'preparing' ? `
            <button class="button button-primary" onclick="updateOrderStatus('${orderId}', 'ready')">
              Mark as Ready
            </button>
          ` : ''}
          ${status === 'ready' ? `
            <span style="color: var(--teal); font-weight: 600;">âœ“ Ready for pickup</span>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

async function updateOrderStatus(orderId, newStatus) {
  try {
    const res = await window.apiFetch(`/api/orders/${orderId}`, {
      method: 'PATCH',
      body: { status: newStatus }
    });

    if (res.ok) {
      // Update local order
      const order = allOrders.find(o => (o.id || o.orderId) === orderId);
      if (order) {
        order.status = newStatus;
        renderOrders();
      }
    } else {
      throw new Error('Failed to update order status');
    }
  } catch (error) {
    console.error('Update failed:', error);
    alert('Failed to update order status. Please try again.');
  }
}

async function handleLogout() {
  try {
    await window.apiFetch('/api/auth/logout', { method: 'POST' });
  } catch (error) {
    console.error('Logout failed:', error);
  }
  navigateTo('/');
}
</script>


