<div class="marketplace-page">
  <!-- Search Header -->
  <div class="search-header">
    <div class="search-header__container">
      <div class="search-bar">
        <svg class="search-bar__icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input 
          type="text" 
          class="search-bar__input" 
          placeholder="Search for cuisines, dishes, or chefs..." 
          id="marketplace-search"
        />
      </div>
      <div class="delivery-selector">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <span id="delivery-address">Hamilton, ON</span>
      </div>
    </div>
  </div>

  <!-- Category Chips -->
  <div class="category-row">
    <div class="category-row__container" id="category-chips">
      <!-- Populated dynamically -->
    </div>
  </div>

  <!-- Today's Offers Carousel -->
  <section class="offers-section">
    <h2 class="section-title">Today's Offers</h2>
    <div class="offers-carousel" id="offers-carousel">
      <!-- Populated dynamically -->
    </div>
  </section>

  <!-- Filters -->
  <div class="filters-row" id="filters-container">
    <button class="filter-chip active" data-sort="best">Best Overall</button>
    <button class="filter-chip" data-sort="rating">Highest Rated</button>
    <button class="filter-chip" data-sort="delivery_fee">Lowest Delivery Fee</button>
    <button class="filter-chip" data-sort="delivery_time">Under 30 min</button>
    <button class="filter-chip" data-sort="price">Price Range</button>
  </div>

  <!-- Featured Near You -->
  <section class="featured-section">
    <h2 class="section-title">Featured Home Cooks Near You</h2>
    <div class="cooks-grid" id="cooks-grid">
      <!-- Populated dynamically -->
    </div>
  </section>

  <!-- All Categories -->
  <section class="categories-section">
    <h2 class="section-title">Browse by Cuisine</h2>
    <div class="cuisine-grid" id="cuisine-grid">
      <!-- Populated dynamically -->
    </div>
  </section>
</div>

<style>
  .marketplace-page {
    min-height: 100vh;
    background: #f8f9fa;
    padding-bottom: 2rem;
  }

  /* Search Header */
  .search-header {
    background: white;
    border-bottom: 1px solid #e9ecef;
    padding: 1.5rem 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .search-header__container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .search-bar {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-bar__icon {
    position: absolute;
    left: 1rem;
    color: #6c757d;
    pointer-events: none;
  }

  .search-bar__input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 3rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 1rem;
    outline: none;
    transition: all 0.2s ease;
  }

  .search-bar__input:focus {
    border-color: #ff7a18;
    box-shadow: 0 0 0 3px rgba(255, 122, 24, 0.1);
  }

  .delivery-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s ease;
  }

  .delivery-selector:hover {
    border-color: #ff7a18;
    background: #fff5f0;
  }

  .delivery-selector svg {
    color: #ff7a18;
  }

  /* Category Row */
  .category-row {
    background: white;
    padding: 1rem 0;
    border-bottom: 1px solid #e9ecef;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .category-row::-webkit-scrollbar {
    display: none;
  }

  .category-row__container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    display: flex;
    gap: 0.75rem;
  }

  .category-chip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .category-chip:hover {
    background: #fff5f0;
    border-color: #ff7a18;
    color: #ff7a18;
  }

  .category-chip.active {
    background: #ff7a18;
    border-color: #ff7a18;
    color: white;
  }

  /* Offers Carousel */
  .offers-section {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .section-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1.25rem;
    color: #212529;
  }

  .offers-carousel {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 0.5rem;
  }

  .offers-carousel::-webkit-scrollbar {
    display: none;
  }

  .offer-card {
    min-width: 350px;
    height: 180px;
    border-radius: 12px;
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .offer-card:hover {
    transform: translateY(-4px);
  }

  .offer-card h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .offer-card p {
    font-size: 1rem;
    opacity: 0.95;
    margin-bottom: 1rem;
  }

  .offer-card .badge {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  /* Filters Row */
  .filters-row {
    max-width: 1200px;
    margin: 2rem auto 1rem;
    padding: 0 1rem;
    display: flex;
    gap: 0.75rem;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .filters-row::-webkit-scrollbar {
    display: none;
  }

  .filter-chip {
    padding: 0.625rem 1rem;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-chip:hover {
    background: #fff5f0;
    border-color: #ff7a18;
    color: #ff7a18;
  }

  .filter-chip.active {
    background: #ff7a18;
    border-color: #ff7a18;
    color: white;
  }

  /* Featured Section */
  .featured-section {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .cooks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
  }

  .cook-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .cook-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  }

  .cook-card__image {
    width: 100%;
    height: 180px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    position: relative;
  }

  .cook-card__badge {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    padding: 0.375rem 0.75rem;
    background: #ff7a18;
    color: white;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .cook-card__content {
    padding: 1rem;
  }

  .cook-card__header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.75rem;
  }

  .cook-card__name {
    font-size: 1.125rem;
    font-weight: 700;
    color: #212529;
    margin: 0 0 0.25rem 0;
  }

  .cook-card__cuisine {
    font-size: 0.875rem;
    color: #6c757d;
  }

  .cook-card__rating {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-weight: 600;
    color: #212529;
  }

  .cook-card__rating svg {
    color: #ffc107;
    fill: #ffc107;
  }

  .cook-card__meta {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.75rem;
  }

  .cook-card__meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .cook-card__tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag {
    padding: 0.25rem 0.625rem;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 0.75rem;
    color: #495057;
  }

  /* Cuisine Grid */
  .categories-section {
    max-width: 1200px;
    margin: 3rem auto;
    padding: 0 1rem;
  }

  .cuisine-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
  }

  .cuisine-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem 1rem;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .cuisine-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  }

  .cuisine-card__icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }

  .cuisine-card__name {
    font-size: 1rem;
    font-weight: 600;
    color: #212529;
  }

  .cuisine-card__count {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
  }

  .empty-state__icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .empty-state__title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  /* Mobile Responsiveness */
  @media (max-width: 768px) {
    .search-header__container {
      flex-direction: column;
    }

    .delivery-selector {
      width: 100%;
      justify-content: center;
    }

    .cooks-grid {
      grid-template-columns: 1fr;
    }

    .cuisine-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }

    .offers-carousel {
      gap: 1rem;
    }

    .offer-card {
      min-width: 280px;
    }
  }
</style>

<script>
(function() {
  'use strict';

  // Initialize marketplace page
  function initMarketplacePage() {
    console.log('[Marketplace] Initializing...');
    
    // Check if demo data is loaded
    if (!window.RideNDineDemoData) {
      console.error('[Marketplace] Demo data not loaded!');
      return;
    }

    const data = window.RideNDineDemoData;

    // Render category chips
    renderCategoryChips(data.categories);

    // Render offers carousel
    renderOffersCarousel(data.getActivePromotions());

    // Render featured cooks
    renderCooksGrid(data.getFeaturedCooks());

    // Render cuisine categories
    renderCuisineGrid(data.cooks);

    // Setup search
    setupSearch();

    // Setup filters
    setupFilters();

    console.log('[Marketplace] Initialized successfully');
  }

  function renderCategoryChips(categories) {
    const container = document.getElementById('category-chips');
    if (!container) return;

    const html = categories.map((cat, index) => `
      <div class="category-chip ${index === 0 ? 'active' : ''}" data-category="${cat.id}">
        <span>${cat.icon}</span>
        <span>${cat.name}</span>
      </div>
    `).join('');

    container.innerHTML = html;

    // Add click handlers
    container.querySelectorAll('.category-chip').forEach(chip => {
      chip.addEventListener('click', function() {
        // Remove active from all
        container.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
        // Add active to clicked
        this.classList.add('active');
        
        // Filter cooks based on category
        const categoryId = this.dataset.category;
        filterCooksByCategory(categoryId);
      });
    });
  }

  function renderOffersCarousel(promotions) {
    const container = document.getElementById('offers-carousel');
    if (!container) return;

    if (promotions.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state__icon">üéÅ</div><div class="empty-state__title">No active promotions right now</div></div>';
      return;
    }

    const gradients = [
      'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
      'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
      'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
    ];

    const html = promotions.map((promo, index) => `
      <div class="offer-card" style="background: ${gradients[index % gradients.length]}">
        <h3>${promo.title}</h3>
        <p>${promo.description}</p>
        <span class="badge">Limited Time</span>
      </div>
    `).join('');

    container.innerHTML = html;
  }

  function renderCooksGrid(cooks) {
    const container = document.getElementById('cooks-grid');
    if (!container) return;

    if (cooks.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state__icon">üë®‚Äçüç≥</div><div class="empty-state__title">No cooks found</div></div>';
      return;
    }

    const html = cooks.map(cook => `
      <div class="cook-card" onclick="navigateTo('/cook/${cook.slug}')">
        <div class="cook-card__image">
          ${cook.promoBadge ? `<div class="cook-card__badge">${cook.promoBadge}</div>` : ''}
        </div>
        <div class="cook-card__content">
          <div class="cook-card__header">
            <div>
              <h3 class="cook-card__name">${cook.kitchenName}</h3>
              <div class="cook-card__cuisine">${cook.cuisineTypes.join(' ‚Ä¢ ')}</div>
            </div>
            <div class="cook-card__rating">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
              ${cook.rating}
            </div>
          </div>
          <div class="cook-card__meta">
            <div class="cook-card__meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              ${cook.avgDeliveryTime} min
            </div>
            <div class="cook-card__meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
              $${cook.deliveryFee.toFixed(2)} delivery
            </div>
            <div class="cook-card__meta-item">
              üí¨ ${cook.reviewCount}
            </div>
          </div>
          <div class="cook-card__tags">
            ${cook.tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>
        </div>
      </div>
    `).join('');

    container.innerHTML = html;
  }

  function renderCuisineGrid(cooks) {
    const container = document.getElementById('cuisine-grid');
    if (!container) return;

    // Group by cuisine type
    const cuisineMap = {};
    const cuisineIcons = {
      'Vietnamese': 'üçú',
      'Mexican': 'üåÆ',
      'Italian': 'üçù',
      'Middle Eastern': 'üßÜ',
      'Vegan': 'üå±',
      'Asian': 'ü•¢'
    };

    cooks.forEach(cook => {
      cook.cuisineTypes.forEach(cuisine => {
        if (!cuisineMap[cuisine]) {
          cuisineMap[cuisine] = 0;
        }
        cuisineMap[cuisine]++;
      });
    });

    const html = Object.entries(cuisineMap).map(([cuisine, count]) => `
      <div class="cuisine-card" onclick="filterByCuisine('${cuisine}')">
        <div class="cuisine-card__icon">${cuisineIcons[cuisine] || 'üçΩÔ∏è'}</div>
        <div class="cuisine-card__name">${cuisine}</div>
        <div class="cuisine-card__count">${count} cook${count !== 1 ? 's' : ''}</div>
      </div>
    `).join('');

    container.innerHTML = html;
  }

  function setupSearch() {
    const searchInput = document.getElementById('marketplace-search');
    if (!searchInput) return;

    let debounceTimer;
    searchInput.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = this.value.trim();
        if (query.length > 0) {
          performSearch(query);
        } else {
          // Reset to featured cooks
          renderCooksGrid(window.RideNDineDemoData.getFeaturedCooks());
        }
      }, 300);
    });
  }

  function performSearch(query) {
    const data = window.RideNDineDemoData;
    const results = data.searchCooks(query);
    renderCooksGrid(results);
  }

  function setupFilters() {
    const filtersContainer = document.getElementById('filters-container');
    if (!filtersContainer) return;

    filtersContainer.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', function() {
        // Remove active from all
        filtersContainer.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        // Add active to clicked
        this.classList.add('active');
        
        // Apply filter
        const sortBy = this.dataset.sort;
        applyFilter(sortBy);
      });
    });
  }

  function applyFilter(sortBy) {
    const data = window.RideNDineDemoData;
    let cooks = [...data.cooks];

    switch (sortBy) {
      case 'rating':
        cooks = data.filterCooks({ sortBy: 'rating' });
        break;
      case 'delivery_fee':
        cooks = data.filterCooks({ sortBy: 'delivery_fee' });
        break;
      case 'delivery_time':
        cooks = data.filterCooks({ sortBy: 'delivery_time' });
        break;
      case 'price':
        // Filter by min order
        cooks = cooks.filter(c => c.minOrder <= 15);
        break;
      case 'best':
      default:
        cooks = data.filterCooks({ sortBy: 'popular' });
        break;
    }

    renderCooksGrid(cooks);
  }

  function filterCooksByCategory(categoryId) {
    const data = window.RideNDineDemoData;
    let cooks = [...data.cooks];

    // Map category IDs to filters
    const categoryFilters = {
      'cat_vegan': { dietary: 'Vegan' },
      'cat_halal': { dietary: 'Halal' },
      'cat_gluten_free': { dietary: 'Gluten-Free' },
      'cat_under_15': { maxMinOrder: 15 },
      'cat_vietnamese': { cuisineType: 'Vietnamese' },
      'cat_mexican': { cuisineType: 'Mexican' },
      'cat_italian': { cuisineType: 'Italian' },
      'cat_middle_eastern': { cuisineType: 'Middle Eastern' }
    };

    const filter = categoryFilters[categoryId];
    if (filter) {
      if (filter.dietary) {
        cooks = cooks.filter(c => c.tags.includes(filter.dietary));
      } else if (filter.cuisineType) {
        cooks = data.filterCooks({ cuisineType: filter.cuisineType });
      } else if (filter.maxMinOrder) {
        cooks = cooks.filter(c => c.minOrder <= filter.maxMinOrder);
      }
    }

    renderCooksGrid(cooks);
  }

  window.filterByCuisine = function(cuisine) {
    const data = window.RideNDineDemoData;
    const cooks = data.filterCooks({ cuisineType: cuisine });
    renderCooksGrid(cooks);
    
    // Scroll to cooks grid
    document.getElementById('cooks-grid').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMarketplacePage);
  } else {
    initMarketplacePage();
  }
})();
</script>
