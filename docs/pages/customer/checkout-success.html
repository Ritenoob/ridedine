<!-- Checkout Success Page -->
<header class="header">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; object-src 'none'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://unpkg.com; script-src 'self' 'unsafe-inline' https://unpkg.com; connect-src 'self' https://ridendine-demo.onrender.com; font-src 'self' data: https:;">
  <div class="header__brand">
    <img src="./assets/logo.png" alt="RideNDine" onerror="this.style.display='none'">
    <h1>RideNDine</h1>
  </div>
  <nav class="header__nav">
    <a onclick="navigateTo('/')" style="cursor: pointer;">Home</a>
    <a onclick="navigateTo('/chefs')" style="cursor: pointer;">Browse Chefs</a>
  </nav>
</header>

<div style="padding: 40px 6vw; max-width: 800px; margin: 0 auto;">
  <div id="success-loading" style="background: #ffffff; border-radius: 24px; padding: 60px 28px; box-shadow: 0 18px 40px rgba(15, 30, 60, 0.08); text-align: center;">
    <div style="font-size: 4rem; margin-bottom: 16px;">â³</div>
    <h2>Verifying your order...</h2>
    <p style="color: var(--muted);">Please wait while we confirm your payment</p>
  </div>

  <div id="success-content" style="display: none; background: #ffffff; border-radius: 24px; padding: 40px 28px; box-shadow: 0 18px 40px rgba(15, 30, 60, 0.08); text-align: center;">
    <div style="font-size: 5rem; margin-bottom: 16px;">âœ…</div>
    <h1 style="color: var(--teal); margin: 0 0 16px 0;">Order Confirmed!</h1>
    <p style="font-size: 1.2rem; color: var(--muted); margin-bottom: 24px;">
      Thank you for your order!
    </p>

    <div style="background: #f7fbfa; border-radius: 16px; padding: 24px; margin-bottom: 24px; text-align: left;">
      <h3 style="margin: 0 0 16px 0;">Order Details</h3>
      <div style="display: grid; gap: 12px;">
        <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid #e0f2f1;">
          <span style="color: var(--muted);">Order Number:</span>
          <strong id="order-number">Loading...</strong>
        </div>
        <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid #e0f2f1;">
          <span style="color: var(--muted);">Order Status:</span>
          <strong style="color: var(--orange);" id="order-status">Processing</strong>
        </div>
        <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid #e0f2f1;">
          <span style="color: var(--muted);">Total Paid:</span>
          <strong style="color: var(--teal);">$<span id="order-total">0.00</span></strong>
        </div>
        <div id="order-items-section">
          <h4 style="margin: 16px 0 8px 0;">Items Ordered:</h4>
          <div id="order-items" style="font-size: 0.9rem; color: var(--muted);">
            <!-- Items will be listed here -->
          </div>
        </div>
      </div>
    </div>

    <div style="background: #fff2e8; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
      <p style="margin: 0; color: var(--orange-dark); font-weight: 600;">
        ðŸ“§ A confirmation email has been sent to your email address
      </p>
    </div>

    <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
      <button class="button button--primary" onclick="trackOrder()" id="track-order-btn">
        Track Your Order
      </button>
      <button class="button button--ghost" onclick="navigateTo('/chefs')">
        Browse More Chefs
      </button>
    </div>
  </div>

  <div id="error-content" style="display: none; background: #ffffff; border-radius: 24px; padding: 40px 28px; box-shadow: 0 18px 40px rgba(15, 30, 60, 0.08); text-align: center;">
    <div style="font-size: 5rem; margin-bottom: 16px;">âš ï¸</div>
    <h2 style="color: #c62828;">Unable to Verify Order</h2>
    <p style="color: var(--muted); margin-bottom: 24px;" id="error-message">
      We couldn't verify your payment. Please contact support if you were charged.
    </p>
    <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
      <button class="button button--primary" onclick="navigateTo('/')">
        Return Home
      </button>
      <button class="button button--ghost" onclick="navigateTo('/order-tracking')">
        Track Order
      </button>
    </div>
  </div>
</div>

<footer class="footer">
  <p>&copy; 2024 RideNDine. Supporting local home chefs.</p>
</footer>

<script>
  let orderId = null;
  let trackingToken = null;

  async function verifyOrder() {
    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    orderId = urlParams.get('orderId');
    trackingToken = urlParams.get('token');

    // Also check sessionStorage
    if (!orderId || !trackingToken) {
      const storedOrder = sessionStorage.getItem('currentOrder');
      if (storedOrder) {
        const orderData = JSON.parse(storedOrder);
        orderId = orderData.orderId;
        trackingToken = orderData.trackingToken;
      }
    }

    if (!orderId || !trackingToken) {
      showError('No order information found. Please contact support if you placed an order.');
      return;
    }

    try {
      // Fetch order details using tracking API
      const orderResponse = await window.apiFetch(`/api/public/track?orderId=${orderId}&token=${trackingToken}`);
      
      if (!orderResponse.ok) {
        const errorData = await orderResponse.json();
        throw new Error(errorData.error?.message || 'Failed to verify order');
      }

      const result = await orderResponse.json();
      
      if (!result.success) {
        throw new Error('Failed to verify order');
      }

      const orderData = result.data;
      
      document.getElementById('order-number').textContent = orderData.orderId;
      document.getElementById('order-status').textContent = orderData.status || 'CREATED';
      document.getElementById('order-total').textContent = orderData.total || '0.00';

      // Display ETA
      if (orderData.eta) {
        document.getElementById('order-status').innerHTML = `${orderData.status}<br><small style="font-weight: normal; color: var(--muted);">ETA: ${orderData.eta}</small>`;
      }

      // Clear cart
      if (window.CartService) {
        window.CartService.clearCart();
      }
      
      // Show success
      document.getElementById('success-loading').style.display = 'none';
      document.getElementById('success-content').style.display = 'block';
      
    } catch (error) {
      console.error('Error loading order:', error);
      showError(error.message || 'Order created successfully! Order #' + orderId);
      // Still show as success if we have an order ID
      if (orderId) {
        document.getElementById('success-loading').style.display = 'none';
        document.getElementById('success-content').style.display = 'block';
        document.getElementById('order-number').textContent = orderId;
      }
    }
  }

  function showError(message) {
    document.getElementById('success-loading').style.display = 'none';
    document.getElementById('error-content').style.display = 'block';
    document.getElementById('error-message').textContent = message;
  }

  function trackOrder() {
    if (orderId && trackingToken) {
      navigateTo(`/track?orderId=${orderId}&token=${trackingToken}`);
    } else {
      navigateTo('/track');
    }
  }

  // Verify order on load
  verifyOrder();
</script>



